
\documentclass[10pt,openany]{article}
% \usepackage{fontspec}
% \usepackage{unicode-math}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,hmargin={4cm,4cm},vmargin={3.5cm,3.5cm}]{geometry}
\usepackage[colorlinks=true,bookmarksopen=false,linkcolor=blue,citecolor=red]{hyperref}
\usepackage{subfiles}
\usepackage{calc} 
\usepackage{datetime}
\usepackage{comment}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amsrefs}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{dsfont}
\usepackage{euscript}
\usepackage{fourier-orns}
%\usepackage{pxfonts}
%\usepackage{newpxtext}
%\usepackage{tgpagella}
\usepackage{palatino}
\usepackage[sc]{mathpazo} % add possibly `sc` and `osf` options
%\usepackage{eulervm}
%\usepackage[adobe-utopia]{mathdesign}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{tikz}
% \usetikzlibrary{tikzmark}
% \usepackage{tikz-cd}
% \tikzcdset{
% arrow style=tikz,
% diagrams={>=latex}
% }

\linespread{1.265}
\setlength{\parindent}{0ex}
\setlength{\parskip}{.4\baselineskip}
\definecolor{blue}{rgb}{0, 0.1, 0.6}

\DeclareFontFamily{OT1}{pzc}{}
\DeclareFontShape{OT1}{pzc}{m}{it}{<-> s * [1.10] pzcmi7t}{}
\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}

\newcommand{\mylabel}[1]{{\ssf{#1}}\hfill}
\renewenvironment{itemize}
  {\begin{list}{$\triangleright$}{%
   \setlength{\parskip}{0mm}
   \setlength{\topsep}{.4\baselineskip}
   \setlength{\rightmargin}{0mm}
   \setlength{\listparindent}{0mm}
   \setlength{\itemindent}{0mm}
   \setlength{\labelwidth}{3ex}
   \setlength{\itemsep}{.4\baselineskip}
   \setlength{\parsep}{0mm}
   \setlength{\partopsep}{0mm}
   \setlength{\labelsep}{1ex}
   \setlength{\leftmargin}{\labelwidth+\labelsep}
   \let\makelabel\mylabel}}{%
   \end{list}\vspace*{-\parskip}}

\def\E{\exists}
\def\A{\forall}
\def\mdot{\mathord\cdot}
\def\models{\vDash}
\def\pmodels{\mathrel{\models\kern-1.5ex\raisebox{.5ex}{*}}}
\def\notmodels{\nvDash}
\def\proves{\vdash}
\def\notproves{\nvdash}
\def\proves{\vdash}
\def\provesT{\mathrel{\mathord{\vdash}\hskip-1.13ex\raisebox{-.5ex}{\tiny$T$}}}
\def\ZZ{\mathds Z}
\def\NN{\mathds N}
\def\QQ{\mathds Q}
\def\RR{\mathds R}
\def\BB{\mathds B}
\def\CC{\mathds C}
\def\PP{\mathds P}
\def\Ar{{\rm Ar}}
\def\dom{\mathop{\rm dom}}
\def\supp{\mathop{\rm supp}}
\def\range{\mathop{\rm img}}
\def\rank{\mathop{\rm rank}}
\def\dcl{\mathop{\rm dcl}}
\def\acl{\mathop{\rm acl}}
\def\fp{{\rm fp}}
\def\cf{\mathop{\rm cf}}
\def\rad{\mathop{\rm rad}}
\def\eq{{{\rm eq}}}
\def\ccl{{\rm ccl}}
\def\Th{\textrm{Th}}
\def\Diag{{\rm Diag}}
\def\atpmTh{\textrm{Th}_\atpm}
\def\Mod{\mathop{\rm Mod}}
\def\Rmod{{\mbox{\scriptsize $R$-mod}}}
\def\Aut{\textrm{Aut\kern.15ex}}
\def\Autf{\mathord{\rm Aut\kern.15ex{f}\kern.15ex}}
\def\Cb{\textrm{Cb\kern.15ex}}
\def\orbit{\O}
\def\oorbit{\mathpzc{o}}
\def\oorbitf{\mathpzc{of\!}}
\def\id{{\rm id}}
\def\tp{{\rm tp}}
\def\atpm{{\tiny\rm at^\pm}}
\def\qftp{\textrm{qf\mbox{-}tp}}
\def\attp{\textrm{at\mbox{-}tp}}
\def\atpmtp{\atpm\mbox{-}\textrm{tp}}
\def\Deltatp{\Delta\mbox{-}\textrm{tp}}
\def\pmDelta{\Delta\hskip-.3ex\raisebox{1ex}{\tiny$\pm$}}
\def\pmDeltatp{\noindent\pmDelta\hskip-.3ex\textrm{-tp}}
\def\EMtp{\textrm{{\small EM}\mbox{-}tp}}

\newcommand{\cev}[1]{\reflectbox{\ensuremath{\vec{\reflectbox{\ensuremath{#1}}}}}}

\def\nonfork{\mathop{\raise0.2ex\hbox{
   \ooalign{\hidewidth$\vert$\hidewidth\cr\raise-0.9ex\hbox{$\smile$}}}}}

\def\cnonfork{\mathbin{\raise1.8ex\rlap{\kern0.6ex\rule{0.6ex}{0.1ex}}
\rlap{\kern1.1ex\rule{0.1ex}{1.9ex}}\raise-0.3ex\hbox{$\smile$} } }

\def\cpaw{\mathbin{\ooalign{\kern-0.4ex$-$\hidewidth\cr$<$}}}
\def\cpawdot{\ooalign{$\kern1.2ex\cdot$\cr$\cpaw$\cr}}

\def\sm{\smallsetminus}
\def\Trm{{\rm Trm}}
\def\IMP{\Rightarrow}
\def\PMI{\Leftarrow}
\def\IFF{\Leftrightarrow}
\def\NIFF{\nLeftrightarrow}
\def\imp{\rightarrow}
\def\pmi{\leftarrow}
\def\iff{\leftrightarrow}
\def\niff{\mathrel{{\leftrightarrow}\llap{\raisebox{-.1ex}{{\small$/$}}\hskip.5ex}}}
\def\nequiv{\mathrel{\mbox{$\equiv$\llap{{\small$/$}\hskip.3ex}}}}

\def\isomap{\rlap{\kern0.8ex\raisebox{1ex}{\scriptsize$\sim$}}\rightarrow}

\def\P{\EuScript P}
\def\D{\EuScript D}
\def\Aa{\EuScript A}
\def\Ee{\EuScript E}
\def\X{\EuScript X}
\def\Y{\EuScript Y}
\def\Z{\EuScript Z}
\def\C{\EuScript C}
\def\U{\EuScript U}
\def\W{\EuScript W}
\def\Hh{\EuScript H}
\def\I{\EuScript I}
\def\V{\EuScript V}
\def\R{\EuScript R}
\def\F{\EuScript F}
\def\G{\EuScript G}
\def\B{\EuScript B}
\def\M{\EuScript M}
\def\N{\EuScript N}
\def\Ll{\EuScript L}
\def\K{\EuScript K}
\def\O{\EuScript O}
\def\J{\EuScript J}
\def\S{\EuScript S}
\def\T{\EuScript T}
\def\<{\langle}
\def\>{\rangle}
\def\0{\varnothing}
\def\theta{\vartheta}
\def\phi{\varphi}
\def\epsilon{\varepsilon}
\def\ssf#1{\textsf{\small #1}}

\titlecontents{section}
[3.8em] % ie, 1.5em (chapter) + 2.3em
{\vskip-1ex}
{\contentslabel{1.5em}}
{\hspace*{-2.3em}}
{\titlerule*[1pc]{}\contentspage}

\titleformat{\section}[block]{\Large\bfseries}{\makebox[5ex][r]{\textbf{\thesection}}}{1.5ex}{}
\titlespacing*{\chapter}{0em}{.5ex plus .2ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\section}{-9.7ex}{3ex plus .5ex minus .5ex}{1ex plus .2ex minus .2ex}

\newtheoremstyle{mio}% name
     {2\parskip}%      Space above
     {\parskip}%      Space below
     {\sl}%         Body font
     {}%          Indent amount (empty = no indent, \parindent = para indent)
     {\bfseries}% Thm head font
     {}%        Punctuation after thm head
     {1ex}%     Space after thm head: " " = normal interword space;
         %   \newline = linebreak
     {\llap{\thmnumber{#2}\hskip2mm}% Thm head spec (empty means `normal')
      \thmname{#1}\thmnote{\bfseries{} #3}}

\newtheoremstyle{liscio}% name
     {2\parskip}%      Space above
     {0mm}%      Space below
     {}%         Body font
     {}%         Indent amount (empty = no indent, \parindent = para indent)
     {\bfseries}% Thm head font
     {}%        Punctuation after thm head
     {1.5ex}%     Space after thm head: " " = normal interword space;
            %   \newline = linebreak
     {\llap{\thmnumber{#2}\hskip2mm}% Thm head spec (empty means `normal')
      \thmname{#1}\thmnote{\bfseries{} #3}}

\newcounter{thm}[section]
\renewcommand{\thethm}{\thesection.\arabic{thm}}

\theoremstyle{mio}
\newtheorem{theorem}[thm]{Theorem}
\newtheorem{corollary}[thm]{Corollary}
\newtheorem{proposition}[thm]{Proposition}
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{fact}[thm]{Fact}
\newtheorem{definition}[thm]{Definition}
\newtheorem{assumption}[thm]{Assumption}
\newtheorem{void_thm}[thm]{}
\theoremstyle{liscio}
\newtheorem{void_def}[thm]{}
\newtheorem{remark}[thm]{Remark}
\newtheorem{notation}[thm]{Notation}
\newtheorem{note}[thm]{Note}
\newtheorem{exercise}[thm]{Exercise}
\newtheorem{example}[thm]{Example}
\setlength{\partopsep}{0mm}
\setlength{\topsep}{0mm}

\def\QED{\noindent\nolinebreak[4]\hspace{\stretch{1}}\rlap{\ \ $\Box$}\medskip}
\renewenvironment{proof}[1][Proof]%
{\begin{trivlist}\item[\hskip\labelsep {\bf #1}]}
{\QED\end{trivlist}}

\newenvironment{void}[1][]%
{\begin{trivlist}\item[\hskip\labelsep {\bf #1}]}
{\QED\end{trivlist}}

\pagestyle{plain}

\definecolor{violet}{RGB}{115, 0, 205}
\definecolor{brown}{RGB}{150, 50, 10}
\definecolor{green}{RGB}{5,110, 35}
\definecolor{emphcolor}{rgb}{.90,.98,.90}

\def\bl{\color{black}}
%\def\bl{\color{brown}}
\def\mr{\color{brown}}
\def\gr{\color{green}}
\def\vl{\color{violet}}

\def\mrA{{\mr\Aa}}
\def\mrB{{\mr\B}}
\def\mrC{{\mr\C}}
\def\mrD{{\mr\D}}
\def\mrE{{\mr\Ee}}
\def\mrG{{\mr\G}}
\def\mrU{{\mr\U}}
\def\mrV{{\mr\V}}
\def\mrS{{\mr\S}}
\def\mrP{{\mr\P}}
\def\mrW{{\mr\W}}
\def\grB{{\gr\B}}
\def\grC{{\gr\C}}
\def\grD{{\gr\D}}
\def\grV{{\gr\V}}

\renewcommand*{\emph}[1]{%
   \kern-0.2ex 
   \smash{\tikz[baseline]
   \node[ rectangle, fill=emphcolor, rounded corners, 
          inner xsep=.3ex, inner ysep=.2ex, anchor=base,
          minimum height = 3ex
         ]{#1};
   }
   \kern-1.2ex 
}

\begin{document}
\raggedbottom
\begin{center}
   {\huge\bfseries Scratch paper\\[3ex] \normalfont\normalsize 
   Anonymous\vskip-1ex 
   Università di Torino\vskip-1ex \monthname\ \the\year}
\end{center}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}

\bigskip\hfil
\parbox{0.9\textwidth}{
   \textbf{Abstract} \ 
   Poche idee, ben confuse.
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}\label{intro}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Preliminaries}\label{pre}
\def\medrel#1{\parbox[t]{6ex}{\hfil$#1$}}
\def\ceq#1#2#3{\parbox[t]{19ex}{$\displaystyle #1$}\medrel{#2}$\displaystyle  #3$}
\def\uuu{{\mathds 1}}
\def\gruuu{{\mathds 1}}
\def\Av{{\rm Av}}
\def\st{{\rm st}}


The \emph{finite (fractional) expansion\/} of a structure $M$ is a many-sorted expansion that has a sort for $M$, which we call the home-sort, a sort for $\RR$, the set of real numbers, and, for every $n$, a sort for the functions $s:M^n\to\RR$ that are almost always $0$. 

We will be maily interested in function that take non negatove values.
%
These will be interpreted as \emph{(fractional) multisets}.
%
Namely $s(a)$ interpreted as the number of occurreces of $a$ in $s$.
%
For this reason, we use the following suggestive notation:
\begin{itemize}
  \item[1.] \ceq{\hfill\emph{$a\in s$}\vphantom{\sum_x} }
  {=}
  {s(a)}\hfill  this is called the  \emph{multiplicity\/} of $a$ in $s$;
  \item[2.] \ceq{\hfill\emph{$|s|$} }
  {=}
  {\sum_{a\in M} a\in s}\hfill  this is called the  \emph{size\/} of $s$;
  \item[3.] 
  \ceq{\hfill\emph{$\big|\big\{a\in s\ :\ \phi(a\,;b)\big\}\big|$}}
  {=}
  {\sum_{a\,\models\phi(x;b)} a\in s.}
\end{itemize}

We call these multisets \emph{samples\/} and refer to their sorts collectively as \emph{sample-sort}.

We will write \emph{$M^{\rm f}$\/} for the expansion above.
%
The language of $M^{\rm f}$ is denoted by \emph{$L^{\rm f}$.}
%
It expands $L$, the language of rings, and the language of vector spaces over $\RR$, which are interpreted in their natural sort. 
%
Moreover, $L^{\rm f}$ has a symbols for the functions in \ssf{1}-\ssf{3} above.
%
In particular, claim \ssf{3} requires a symbol for every $\phi(x\,;z)\in L$.


%For ease of exposition we may also use rational numbers, though these need not have their own sort as they are interpretable in the naturar numbers.

Let $\U$ be a monster model of cardinality $\kappa$, a cardinal larger than the cardinality of $L$.
%
We introduce two elementary extension of $\U^{\rm f}$.


\begin{definition}
We denote by \emph{$\U^{\rm f_*}$\/} a saturated elementary extension of $\U^{\rm f}$ of cardinality $\kappa$.
%
As all saturated models of cardinality $\kappa$ are isomorphic, we can assume that $\U$ is the home-sort of $\U^{\rm f_*}$.
%
We denote by \emph{$\U^{\rm f^+_*}$\/} some elementary extension of $\U^{\rm f_*}$ that realizes all types in $S(\U^{\rm f_*})$.
%
Hence we have $\U^{\rm f}\prec\U^{\rm f_*}\prec\U^{\rm f^+_*}$.
%
Elements of sample-sort in these models are called  \emph{finite samples,} \emph{internal samples,} and \emph{external samples\/} respectively.\QED
%
%Elements  of sample-sort in $\U^{\rm f_*}$ are called \emph{smoth samples.}
\end{definition}

The use of $\U^{\rm f^+_*}$ is not ideal, it is introduced to replace the use of global types of sample-sort which also have drawbacks.

 We write \emph{$\supp(s)$\/} for the \emph{support\/} of $s$, that is, the set of those $a$ in $\U^{\rm f^+_*}$ such that $a\in s$ is positive.
 

% \begin{definition}[???]
%   We say that $\U$ is \emph{pseudofinite\/} every definable set is the support of a sample.\QED
% \end{definition}

Let $s$ be an external sample.
%
For every formula $\phi(x\,;z)\in L$ and every $b\in\U^{|z|}$ we define

\ceq{\hfill\emph{$\Av_{s}\,\phi(x\,;b)$} }
{=}
{\frac{\big|\big\{a\in s\ :\ \phi(a\,;b)\big\}\big|}
{|s|}},

%
%If we pretend that hyperrational are elements of $\U^{\rm f^+_*}$, then $\Av_{s}\,\phi(x\,;b)$, as a function of $s$ and $b$, is definable in $\U^{\rm f^+_*}$.

Below, $\epsilon$ always ranges over the positive standard reals.
%
If $a$ and $b$ are hyperreals, we write \emph{$a\approx_\epsilon b$\/} for $|a-b|<\epsilon$.
%
We write \emph{$a\approx b$\/} if $a\approx_\epsilon b$ holds for every $\epsilon$.
%
%If $\mu$ is a real number we write $a\approx_\epsilon \mu$ if there is a standard rational $b\approx_{\epsilon/2} a$ such that $|b-\mu|<\epsilon/2$ (this last inequality is evaluated in the standard real line).
%
We write $\st(a)$, for the standard part of the hyperrational number $a$.
%
That is, the unique real number $\mu$ such that $\mu\approx a$.

The standard part of $\Av_s$ induces a finite probability measure on the algebra of definable subsets of $\U^{|x|}$.
%
This measure has an unique extension to a Lebesgue probability measure on a $\sigma$-algebra.
%
This is known as the \emph{Loeb measure.}



\begin{definition} We say that the external sample $s$ is \emph{smooth\/} for $\phi(x\,;z)$ over $M$ if, for every $s'\equiv_Ms$ and every $b\in\U^{|z|}$, we have $\Av_{s'}\,\phi(x\,;b)\approx\Av_{s}\,\phi(x\,;b)$.\QED
\end{definition}

\begin{definition}
  Let  $\phi(x\,;z)\in L$ and let $M$ be a model.
  %
 An external sample $s$ is 
  \begin{itemize}
    \item[1.]\noindent \emph{invariant\/} if, for every $b'\equiv_Mb\in\U^{|z|}$, we have $\Av_s\,\phi(x\,;b)\approx\Av_{s}\,\phi(x\,;b')$.
    \item[2.] \noindent \emph{definable\/} if, for every $\epsilon$, the set $\{b\in\U^{|z|}:\Av_s\phi(x\,;b)<\epsilon\}$ is definable over $M$.
    \item [3.]\noindent  \emph{satisfiable\/} if, for all $b\in\U^{|z|}$, if $\Av_s\phi(x\,;b)\not\approx0$, then  $\phi(a\,;b)$ for some $a\in M^{|z|}$.
    \item[4.] \noindent  \emph{generically stable\/} if all of the above holds. 
  \end{itemize}
  When $\phi(x\,;z)$ and $M$ are not clear from the context we add: \emph{for $\phi(x\,;z)$ over/in $M$.}
  \end{definition}


\begin{fact}
  Smooth samples are generically stable. (For some given $\phi(x\,;z)$ and $M$.)
\end{fact}

\begin{proof}
  We prove in turn \ssf{1}-\ssf{3} of the definition above.
  
  \ssf{1.} If $s$ is smooth for $\phi(x\,;z)$ over $M$, then there is an internal sample $s'\in\U^{\rm f_*}$ such that $\Av_{s'}\,\phi(x\,;b)\approx\Av_{s}\,\phi(x\,;b)$ for all $b\in\U^{|z|}$.
  %
  Then \ssf{1} follows.
  
  \ssf{2.} The set $\{b\in\U^{|z|}:\Av_s\phi(x\,;b)<\epsilon\}$ is definable in $\U^{\rm f_*}$ because, by invariance of $s$, we may replace $s$ with any internal sample $s'\equiv_Ms$.
  %
  As this set is invariat over $M$, it is definable over $M^{\rm f}$ and therefore, over $M$.
  
  \ssf{3.} Let $b\in\U^{|z|}$ be such that  $\Av_s\phi(x\,;b)>\epsilon$.
  %
  Pick a  external sample $s'$  such that $s\equiv_Ms'\cnonfork_{M^{\rm f}}b$.
  %
  By the smoothness of $s$, we obtain $\Av_{s'}\phi(x\,;b)>\epsilon$.
  %
  Let $s_0\in M^{\rm f}$ such that $\Av_{s_0}\phi(x\,;b)>\epsilon$.
  %
  Clearly, some element of $\supp(s_0)$ proves $\ssf{3}$.
\end{proof}

Smooth samples are invariant. 
%
The converse need not be true in general, but we have the following.

\begin{fact}
  For every internal sample $s$, the following are equivalent
  \begin{itemize}
    \item[1.] $s$ is invariant for $\phi(x\,;z)$ over $M$;
    \item[2.] $s$ is smooth for $\phi(x\,;z)$ over $M$.
  \end{itemize}
\end{fact}

\begin{proof}
  By the fact above, implication \ssf{2}$\IMP$\ssf{1} holds for every external sample.
  %
  We prove \ssf{1}$\IMP$\ssf{2}.
  %
  Let $s\in\U^{\rm f_*}$ be an invariat internal sample.
  %  
  Assume for a contradiction that $\Av_{s'}\,\phi(x\,;b)\not\approx_\epsilon\Av_{s}\,\phi(x\,;b)$ for some $b\in\U^{|x|}$ and some external sample $s'\equiv_M s$.
  %
  Pick a internal sample $s''\equiv_{M,s}s'$. 
  %
  Then $\Av_{s''}\,\phi(x\,;b)\not\approx_\epsilon\Av_{s}\,\phi(x\,;b)$.
  %
  As $s''\equiv_Ms$ are both in $\U^{\rm f_*}$, this contradicts the invariance of $s$.
\end{proof}

The following is a useful characterization of smoothness.

\begin{lemma}
  The following are equivalent for every external sample $s$
  \begin{itemize}
    \item[1.] $s$ is smooth over $M$;
    \item[2.] for every $b\in\U^{|z|}$ there is a finite sample $s_0\in M^{\rm f}$ such that $\Av_s\phi(x\,;b)\approx_\epsilon\Av_{s_0}\phi(x\,;b)$. (The sample $s_0$ depends on $M$, epsilon and $b$.)
    \item[3.] there are some finite samples $s_1,\dots,s_n\in M^{\rm f}$ such that for every $b\in\U^{|z|}$ we have $\Av_s\phi(x\,;b)\approx_\epsilon\Av_{s_i}\phi(x\,;b)$ for some $s_i$. (The samples $s_1,\dots,s_n$ as well as the number $n$ depend on $\epsilon$ and $M$.)
  \end{itemize}
\end{lemma}

\begin{proof}
  Implication \ssf{3}$\IMP$\ssf{1} is clear.
  %
  We prove \ssf{1}$\IMP$\ssf{2}, so, fix a $b\in\U^{|z|}$.
  %
  Let $\mu$ be the standard part of $\Av_s\phi(x\,;b)$
  %
  Let $s'$ be an external sample such that $s\equiv_Ms'\cnonfork_{M^{\rm f}}b$.
  %
  By smoothness, $\Av_{s'}\phi(x\,;b)\approx\mu$.
  %
  As $s'\cnonfork_{M^{\rm f}}b$ there is an $s_0\in M^{\rm f}$ such that $\Av_{s_0}\phi(x\,;b )\approx_\epsilon\mu$.

  We prove \ssf{2}$\IMP$\ssf{3} by compactness.
  %
  Suppose not, then the following global type is dinitely consistent, hence realized in $\U^{\rm f^+_*}$

\ceq{\hfill p(y)}{=}{\Big\{\Av_y\phi(x,b)\not\approx_\epsilon\Av_{s_0}\phi(x\,;b)\ :\  s_0\in M^{\rm f},\ b\in\U^{|z|}  \Big\}}

This is a contradiction.
\end{proof}


% The following is stronger form of invariance.


% \begin{definition}
%   Let  $\phi(x\,;z)\in L$.
  
%   We say that a sample $s$ of $M^{|x|}$ is $\phi$-smooth over $M$ if there is a finite $S\subseteq M^{|x|}$ such that $\Av_s\,\phi(x\,;b)\approx\Av_S\,\phi(x\,;b)$ for all $b\in M^{|z|}$.
%   We say that an external sample $s$ is \emph{smooth\/} for $\phi(x\,;z)$ over $M$ if for any other sample $s'$ such that $\Av_s\,\phi(x\,;b)\approx\Av_{s'}\,\phi(x\,;b)$ for all $b\in M^{|z|}$, the same equivalence holds for all $b\in\U^{|z|}$.\QED
% \end{definition}

% Clearly, smooth impies invariant.


\begin{theorem}\label{thm_VC}
  Let  $\phi(x\,;z)\in L$ be a nip formula.
  %
  For every external sample $s$ there is a finite sample $s_0\in M^{\rm f}$ such that $\Av_s\phi(x\,;b)\approx_\epsilon\Av_{s_0}\,\phi(x\,;b)$ for all $b\in M^{|z|}$. (The sample $s_0$ depends on $\epsilon$ and $M$.)
  
  Moreover, the cardinality of $s_0$ soley depends on $\epsilon$, namely

  \ceq{\hfill |s_0|}{\le}{c\,\frac{k}{\epsilon^{\scriptscriptstyle 2}}\ln\frac k\epsilon}

  where $c$ is an absolute constant and $k$ is the VC-dimension of $\phi(x\,;z)$.
\end{theorem}

\begin{proof}
  Questo è Vapnik-Chervonenkis.
\end{proof}


For smooth external samples the Vapnik-Chervonenkis Theorem can be strengthened as follows. (The difference is that below $b$ ranges over $\U^{|z|}$.)

\begin{corollary}
  Let  $\phi(x\,;z)\in L$ be nip.
  %
  For every smooth external sample $s$ there is a finite sample $s_0\in M^{\rm f}$ such that $\Av_s\phi(x\,;b)\approx_\epsilon\Av_{s_0}\,\phi(x\,;b)$ for all $b\in\U^{|z|}$.
\end{corollary}

\begin{proof}
  By Theorem~\ref{thm_VC}, there is an $s_0\in M^{\rm f}$ such that $\Av_s\phi(x\,;b)\approx_\epsilon\Av_{s_0}\,\phi(x\,;b)$ for all $b\in M^{|z|}$.
  
  Suppose for a contradiction that $\Av_s\phi(x\,;b')\not\approx_\epsilon\Av_{s_0}\,\phi(x\,;b')$ for some $b'\in\U^{|z|}$.
  %
  Pick a  $s'\subseteq\U^{|x|}$ such that $b'\cnonfork_{M}s'\equiv_Ms$.
  %
  By the smoothness of $s$, we obtain $\Av_{s'}\phi(x\,;b')\not\approx_\epsilon\Av_{s_0}\,\phi(x\,;b')$.
  %
  As $b'\cnonfork_{M}s'$, the same formula holds for some $b\in M^{|z|}$.
  %
  Once again by smoothness, $\Av_s\phi(x\,;b)\not\approx_\epsilon\Av_{s_0}\,\phi(x\,;b)$.
  %
  A contradiction.
\end{proof}

\begin{lemma}\label{lem_cons}
  For every nip formula $\phi(x\,;z)\in L$, every external sample $s$ and every infinite set $B\subseteq\U^{|z|}$ such that $\Av_s\phi(x\,;b)>\epsilon$ for every $b\in B$, there is a finite cover of $B$, say $B_1,\dots, B_n$, such that all types $p_i(x)=\{\phi(x\,;b):b\in B_i\}$ are consistent.
\end{lemma}

\begin{proof}
  Let $M$ be any model containing $B$.
  %
  Fix some $\epsilon'<\epsilon$.
  %
  Let $s_{M,\epsilon'}$ be the hyper given by Theorem~\ref{thm_VC}.
  %
  Then $\supp(s_{M,\epsilon'})$ is finite, say $\supp(s_{M,\epsilon'})=\{a_1,\dots,a_n\}$.
  %
  Let $B_i=\{b\in B:\phi(a_i\,;b)\}$.
  % 
  As $\Av_{s_{M.\epsilon'}}\phi(x\,;b)>0$ for all $b\in B$, these $B_i$ are the required cover of $B$.
\end{proof}


\begin{corollary}
  Let $\psi(x\,;z)\in L$ be a nip formula and let $s$ be an external sample.
  %
  Then there is no infinite set $C$ such that $\Av_s\big[\psi(x\,;c)\niff\psi(x\,;c')\big]>\epsilon$ for all $c,c'\in C$, $c\neq c'$.
\end{corollary}

\begin{proof}
  Suppose for a contradiction that a set $C$ as above exists. Apply Lemma~\ref{lem_cons} to the folmula $\phi(x\,;z,z') = [\psi(x\,;z)\niff\psi(x\,;z')]$ and the set $B=\{\<c,c'\>\in C^2:c\neq c'\}$.
  %
 The sets $B_i$ obtained from the lemma induce a finite coloring of the complete graph on $C$.
 %
 By the Ramsey theorem there is an infinite monochromatic set $A\subseteq C$.
 %
 Hence $\{\psi(x\,;a)\niff\psi(x\,;a') : a,a'\in A, a\neq a'\}$ is consistent.
 %
 This is impossible for $|A|>2$.
\end{proof}

The following is another immediate consequence of the lemma (it holds also when $\phi(x\,;z)$ is not nip, though the proof is lengthier).

\begin{corollary}
  For every nip formula $\phi(x\,;z)\in L$, every external sample $s$ and every sequence of indiscernibles $\<b_i:i<\omega\>$ such that $\Av_s\phi(x\,;b_i)>\epsilon$ for every $i<\omega$, the type $\{\phi(x\,;b_i):i<\omega\}$ is consistent.\QED
\end{corollary}



\begin{definition}
  A formula $\phi(x\,;z)\in L$ is \emph{distal\/} if there is a formula $\psi(x\,;z_1,\dots z_n)\in L$ such that for every finite set $A\subseteq\U^{\rm f}$ and every $b\in\U^{|x|}$ there are $a_1,\dots,a_n\in \supp(s)$ such that $\psi(x\,;a_1,\dots,a_n)\iff p(x)$, where $p(x)=\tp_\phi(b/A)$.\QED
\end{definition}

\begin{theorem}[(false)]
  The following are equivalent
  \begin{itemize}
    \item[1.] $\phi(x\,;z)\in L$ is distal;
    \item[2.] for every external sample $s\in\U^{\rm f^+_*}$, if $s$ is generically stable for $\phi(x\,;z)$ over $M$ then $s$ is smooth for $\phi(x\,;z)$ over $M$.
  \end{itemize}
\end{theorem}

\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Uniform samples}\label{samples}
We call $\U$ the domain of the home sort.
%
This curries all the structure.
%
The domain of the second sort, 

Fix a tuple of variables $x$ and let $\bar x=\<x_i:i<\omega\>$, where $|x_i|=|x|$.
%
For $p(\bar x)\in S(\U)$ and $\psi(x)\in L(\U)$ we define ($n>1$)

\ceq{\hfill\emph{$\Av_{p\restriction n}\,\psi(x)$} }
{=}
{\frac1n\Big|\big\{i<n\ :\ p(\bar x)\proves\psi(x_i)\big\}\Big|}

If $p(\bar x)$ is the type containing $\b ar x=\bar a$ for some $\bar a\in \U^{|x|\cdot\omega}$,
we write \emph{$\Av_{\bar a{\restriction n}}\,\psi(x)$.}

\begin{definition}
  We say that $p(\bar x)\in S(\U)$ is a \emph{sample\/}
  if the limit below exists for every formula $\psi(x)\in L(\U)$.

  \ceq{\hfill\emph{$\Av_p\,\psi(x)$}}{=}{\lim_{n\to\infty}\Av_{p\restriction n}\,\psi(x).}

  Let $\phi(x,z)\in L$ be given.
  %
  We say that $p(\bar x)$ is a \emph{$\phi$-sample\/} 
  if the formula $\psi(x)$ above is restricted to range over those of the form $\phi(x,b)$ 
  for $b\in\U^{|z|}$.

  We say that $p(\bar x)$ is a \emph{uniform $\phi$-sample\/} if it is a sample and 
  for every $\epsilon>0$ there is a $k$ such that $\Av_{p\restriction n}\,\phi(x,b)$ 
  is within $\epsilon$ from $\Av_p\,\phi(x,b)$ for all $n>k$ and $b\in\U^{|z|}$.

  We say that $p(\bar x)$ is a \emph{uniform sample\/} if it is a uniform 
  $\phi$-sample for all $\phi(x,z)\in L$.\QED
\end{definition}

\begin{proposition}
  Let $p(\bar x)\in S(\U)$ be a sample finitely satisfied in $M$.
  %
  Let $q(x)\in S(M)$.
  %
  Then for every formula $\phi(x)\in L(\U)$ either 
  
  \hfil$\displaystyle\inf\Big\{\Av_p\,\big(\psi(x)\wedge\phi(x)\big)\ :\ \psi(x)\in q\Big\}$
  
  is either $0$ or $\Av_p\,\phi(x)$.
\end{proposition}
\begin{proof}
  As $p(\bar x)$ is finitely satisfied in $M$ there is a tuple in $\bar a\in M^{|x|\cdot n}$
  such that $\Av_{\bar a}\,\big(\psi(x)\wedge\phi(x)\big)$ is within $\epsilon$ form the 
  infimum above.
\end{proof}

Define

\ceq{\hfill\emph{$\Av_{p\restriction n}\,q(x)$}}
{=}
{\inf\Big\{\Av_{p\restriction n}\,\psi(x)\ :\ \psi(x)\in q\Big\}}

Clearly the infimum above is attained.

\begin{proposition}
      If $p(\bar x)$ is a sample and $q(x)\subseteq L(\U)$, then
      
      \ceq{\hfill\lim_{n\to\infty}\Av_{p\restriction n}\,q(x)}
      {=}
      {\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\}}
\end{proposition}

\begin{proof}
      Fix $\epsilon>0$.
      %
      Let $\phi(x)\in q$ be such that $\Av_p\,\phi(x)$ is within $\epsilon$ from the infimum above.
      %
      Let $k$ be such that $\Av_{p\restriction n}\,\phi(x)$ is within $\epsilon$ from  $\Av_p\,\phi(x)$ for every $n>k$.
      %
      Then, for every $n>k$,

      \ceq{\hfill\Av_{p\restriction n}\,q(x)}
      {\le}
      {\Av_{p\restriction n}\,\phi(x)}

      \ceq{}
      {\le}
      {\Av_p\,\phi(x) + \epsilon}

      \ceq{}
      {\le}
      {\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\} + 2\epsilon}

      For the converse inequality we inductively pick a sequence of integers $n_i$ and formulas $\psi_i(x)\in q$ as follows.
      %
      Let $n_0=1$ and $\psi_i(x)$ such that $\Av_{p\restriction {n_i}}\,\psi_i(x)=\Av_{p\restriction {n_i}}\,q(x)$.
      %
      Then $n_{i+1}$ be such that $\Av_p\,\psi_i(x)\le\Av_{p\restriction {n_{i+1}}}\,\psi_i(x)+\epsilon$.
      %
      Then

      \ceq{\hfill\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\}}
      {\le}
      {\inf\Big\{\Av_p\,\psi_i(x)\ :\ i<\omega\Big\}}

      \ceq{}
      {\le}
      {\inf\Big\{\Av_{p\restriction {n_{i+1}}}\,\psi_i(x)\ :\ i<\omega\Big\} + \epsilon}
      % {\Av_{p\restriction n}\,q(x) + \epsilon}
\end{proof}

\begin{corollary}
      Let $p(\bar x)$ be a sample finitely satisfied in $M$.
      %
      Let $q'(x)=q(x)\cup\{\phi(x)\}$ for $q(x)\in S(M)$ and $\phi(x)\in L(\U)$.
      %
      Then $\Av_p\,q'(x)$ is either $0$ or $1$.
\end{corollary}
\begin{proof}
Under the assumptions of the corollary, for every $\epsilon>0$ there is an $n$ and a tuple $\bar a\in M^{|x|\cdot\omega}$ such that $\Av_{\bar a{\restriction n}}\,q'(x)$ is within $\epsilon$ from $\Av_p\,q'(x)$. As $\Av_{\bar a{\restriction n}}\,q'(x)$
\end{proof}



\begin{proposition}
      Let $\bar x=\<x_i:i<\omega\>$ and $|x_i|=|x|$ and let $p(\bar x)\in S(\U)$.
      %  
      Then the following are equivalent 
      \begin{itemize}
            \item[1.] $p(\bar x)$ is a uniform global sample;
            \item[2.] for every $\epsilon>0$, there is an $n$ and a formula $\theta(\bar x)\in p$ such that $\Av_n\big(\bar a;\phi(x,b)\big)$ is within $\epsilon$ from $\Av_p\phi(x,b)$ for all $b\in\U^{|z|}$ and all $\bar a\models\theta(\bar x)$.
      \end{itemize}
\end{proposition}

\begin{proof}
???
\end{proof}

Vale anche/solo/nemmeno la versione non uniforme della proposizione?

Note that, if $p(\bar x)$ is definable, say over $M$, then there is a formula $\psi_{m/n}(z)\in L(M)$ such that

\ceq{\hfill\psi_{m/n}(z)}{\IFF}{\Av_n\big(p(\bar x);\phi(x,z)\big)=\frac{m}{n}.}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{References}
\begin{biblist}[]\normalsize

\bib{DK}{book}{
   author={Dodos, Pandelis},
   author={Kanellopoulos, Vassilis},
   title={\href{http://users.uoa.gr/~pdodos/Publications/RT.pdf}
         {Ramsey theory for product spaces}},
   series={Mathematical Surveys and Monographs},
   volume={212},
   publisher={American Mathematical Society},
%   publisher={American Mathematical Society, Providence, RI},
   date={2016},
}
\bib{DZ}{book}{
   author={Zambella, Domenico},
   title={\href{https://github.com/domenicozambella/creche/raw/master/creche.pdf}
         {A cr\`eche course in model theory}},
   date={2018}, 
   series={AMS Open Math Notes}, 
   note={(The link points to the github version)}
}
\end{biblist}

\end{document}
