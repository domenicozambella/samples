\documentclass[10pt]{article}
% \usepackage{fontspec}
% \usepackage{unicode-math}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,hmargin={4cm,4cm},vmargin={3.5cm,3.5cm}]{geometry}
% \usepackage[colorlinks=true,bookmarksopen=false,linkcolor=blue, itecolor=red]{hyperref}
\usepackage{subfiles}
\usepackage{calc} 
\usepackage{datetime}
\usepackage{comment}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amsrefs}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{dsfont}
\usepackage{euscript}
\usepackage{fourier-orns}
%\usepackage{pxfonts}
%\usepackage{newpxtext}
%\usepackage{tgpagella}
\usepackage{palatino}
\usepackage[sc]{mathpazo} % add possibly `sc` and `osf` options
%\usepackage{eulervm}
%\usepackage[adobe-utopia]{mathdesign}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{tikz}
% \usetikzlibrary{tikzmark}
% \usepackage{tikz-cd}
% \tikzcdset{
% arrow style=tikz,
% diagrams={>=latex}
% }

\linespread{1.265}
\setlength{\parindent}{0ex}
\setlength{\parskip}{.4\baselineskip}
\definecolor{blue}{rgb}{0, 0.1, 0.6}

\DeclareFontFamily{OT1}{pzc}{}
\DeclareFontShape{OT1}{pzc}{m}{it}{<-> s * [1.10] pzcmi7t}{}
\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}

\newcommand{\mylabel}[1]{{\ssf{#1}}\hfill}
\renewenvironment{itemize}
  {\begin{list}{$\triangleright$}{%
   \setlength{\parskip}{0mm}
   \setlength{\topsep}{.4\baselineskip}
   \setlength{\rightmargin}{0mm}
   \setlength{\listparindent}{0mm}
   \setlength{\itemindent}{0mm}
   \setlength{\labelwidth}{3ex}
   \setlength{\itemsep}{.4\baselineskip}
   \setlength{\parsep}{0mm}
   \setlength{\partopsep}{0mm}
   \setlength{\labelsep}{1ex}
   \setlength{\leftmargin}{\labelwidth+\labelsep}
   \let\makelabel\mylabel}}{%
   \end{list}\vspace*{-\parskip}
  }

\def\E{\exists}
\def\A{\forall}
\def\mdot{\mathord\cdot}
\def\models{\vDash}
\def\pmodels{\mathrel{\models\kern-1.5ex\raisebox{.5ex}{*}}}
\def\notmodels{\nvDash}
\def\proves{\vdash}
\def\notproves{\nvdash}
\def\proves{\vdash}
\def\provesT{\mathrel{\mathord{\vdash}\hskip-1.13ex\raisebox{-.5ex}{\tiny$T$}}}
\def\ZZ{\mathds Z}
\def\NN{\mathds N}
\def\QQ{\mathds Q}
\def\RR{\mathds R}
\def\BB{\mathds B}
\def\CC{\mathds C}
\def\PP{\mathds P}
\def\Ar{{\rm Ar}}
\def\dom{\mathop{\rm dom}}
\def\supp{\mathop{\rm supp}}
\def\range{\mathop{\rm img}}
\def\rank{\mathop{\rm rank}}
\def\dcl{\mathop{\rm dcl}}
\def\acl{\mathop{\rm acl}}
\def\fp{{\rm fp}}
\def\lh{{\rm lh\,}}
\def\cf{\mathop{\rm cf}}
\def\rad{\mathop{\rm rad}}
\def\eq{{{\rm eq}}}
\def\ccl{{\rm ccl}}
\def\Th{\textrm{Th}}
\def\Diag{{\rm Diag}}
\def\atpmTh{\textrm{Th}_\atpm}
\def\Mod{\mathop{\rm Mod}}
\def\Rmod{{\mbox{\scriptsize $R$-mod}}}
\def\Aut{\textrm{Aut\kern.15ex}}
\def\Autf{\mathord{\rm Aut\kern.15ex{f}\kern.15ex}}
\def\Cb{\textrm{Cb\kern.15ex}}
\def\orbit{\O}
\def\oorbit{\mathpzc{o}}
\def\oorbitf{\mathpzc{of\!}}
\def\id{{\rm id}}
\def\tp{{\rm tp}}
\def\atpm{{\tiny\rm at^\pm}}
\def\qftp{\textrm{qf\mbox{-}tp}}
\def\attp{\textrm{at\mbox{-}tp}}
\def\atpmtp{\atpm\mbox{-}\textrm{tp}}
\def\Deltatp{\Delta\mbox{-}\textrm{tp}}
\def\pmDelta{\Delta\hskip-.3ex\raisebox{1ex}{\tiny$\pm$}}
\def\pmDeltatp{\noindent\pmDelta\hskip-.3ex\textrm{-tp}}
\def\EMtp{\textrm{{\small EM}\mbox{-}tp}}
\def\Fr{\mathop{\rm Fr}}

\newcommand{\cev}[1]{\reflectbox{\ensuremath{\vec{\reflectbox{\ensuremath{#1}}}}}}
\newcommand{\sbar}[1]{\mkern 3mu\overline{\mkern-3mu#1\mkern-1mu}\mkern 1mu}
\newcommand{\barM}{\mkern 4mu\overline{\mkern-4mu M\mkern-2mu}\mkern 2mu}
\newcommand{\barU}{\mkern 2mu\overline{\mkern-2mu\U\mkern-2mu}\mkern 2mu}
\newcommand{\barL}{\mkern 2.5mu\overline{\mkern-2.5mu L\mkern-3.5mu}\mkern 3.5mu}

\def\nonfork{\mathop{\raise0.2ex\hbox{
   \ooalign{\hidewidth$\vert$\hidewidth\cr\raise-0.9ex\hbox{$\smile$}}}}}

\def\cnonfork{\mathbin{\raise1.8ex\rlap{\kern0.6ex\rule{0.6ex}{0.1ex}}
\rlap{\kern1.1ex\rule{0.1ex}{1.9ex}}\raise-0.3ex\hbox{$\smile$} } }

\def\cpaw{\mathbin{\ooalign{\kern-0.4ex$-$\hidewidth\cr$<$}}}
\def\cpawdot{\ooalign{$\kern1.2ex\cdot$\cr$\cpaw$\cr}}

\def\sm{\smallsetminus}
\def\Trm{{\rm Trm}}
\def\IMP{\Rightarrow}
\def\PMI{\Leftarrow}
\def\IFF{\Leftrightarrow}
\def\NIFF{\nLeftrightarrow}
\def\imp{\rightarrow}
\def\pmi{\leftarrow}
\def\iff{\leftrightarrow}
\def\niff{\mathrel{{\leftrightarrow}\llap{\raisebox{-.1ex}{{\small$/$}}\hskip.5ex}}}
\def\nimp{\mathrel{{\rightarrow}\llap{\raisebox{-.1ex}{{\small$/$}}\hskip.5ex}}}
\def\nequiv{\mathrel{\mbox{$\equiv$\llap{{\small$/$}\hskip.3ex}}}}

\def\isomap{\rlap{\kern0.8ex\raisebox{1ex}{\scriptsize$\sim$}}\rightarrow}

\def\P{\EuScript P}
\def\D{\EuScript D}
\def\Aa{\EuScript A}
\def\Ee{\EuScript E}
\def\X{\EuScript X}
\def\Y{\EuScript Y}
\def\Z{\EuScript Z}
\def\C{\EuScript C}
\def\U{\EuScript U}
\def\W{\EuScript W}
\def\Hh{\EuScript H}
\def\I{\EuScript I}
\def\V{\EuScript V}
\def\R{\EuScript R}
\def\F{\EuScript F}
\def\G{\EuScript G}
\def\B{\EuScript B}
\def\M{\EuScript M}
\def\N{\EuScript N}
\def\Ll{\EuScript L}
\def\K{\EuScript K}
\def\O{\EuScript O}
\def\J{\EuScript J}
\def\S{\EuScript S}
\def\T{\EuScript T}
\def\<{\langle}
\def\>{\rangle}
\def\0{\varnothing}
\def\theta{\vartheta}
\def\phi{\varphi}
\def\epsilon{\varepsilon}
\def\ssf#1{\textsf{\small #1}}

\titlecontents{section}
[3.8em] % ie, 1.5em (chapter) + 2.3em
{\vskip-1ex}
{\contentslabel{1.5em}}
{\hspace*{-2.3em}}
{\titlerule*[1pc]{}\contentspage}

\titleformat{\section}[block]{\Large\bfseries}{\makebox[5ex][r]{\textbf{\thesection}}}{1.5ex}{}
\titlespacing*{\chapter}{0em}{.5ex plus .2ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\section}{-9.7ex}{3ex plus .5ex minus .5ex}{1ex plus .2ex minus .2ex}

\newtheoremstyle{mio}% name
     {2\parskip}%      Space above
     {\parskip}%      Space below
     {\sl}%         Body font
     {}%          Indent amount (empty = no indent, \parindent = para indent)
     {\bfseries}% Thm head font
     {}%        Punctuation after thm head
     {1ex}%     Space after thm head: " " = normal interword space;
         %   \newline = linebreak
     {\llap{\thmnumber{#2}\hskip2mm}% Thm head spec (empty means `normal')
      \thmname{#1}\thmnote{\bfseries{} #3}}

\newtheoremstyle{liscio}% name
     {2\parskip}%      Space above
     {0mm}%      Space below
     {}%         Body font
     {}%         Indent amount (empty = no indent, \parindent = para indent)
     {\bfseries}% Thm head font
     {}%        Punctuation after thm head
     {1.5ex}%     Space after thm head: " " = normal interword space;
            %   \newline = linebreak
     {\llap{\thmnumber{#2}\hskip2mm}% Thm head spec (empty means `normal')
      \thmname{#1}\thmnote{\bfseries{} #3}}

\newcounter{thm}[section]
\renewcommand{\thethm}{\thesection.\arabic{thm}}

\theoremstyle{mio}
\newtheorem{theorem}[thm]{Theorem}
\newtheorem{corollary}[thm]{Corollary}
\newtheorem{proposition}[thm]{Proposition}
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{fact}[thm]{Fact}
\newtheorem{definition}[thm]{Definition}
\newtheorem{assumption}[thm]{Assumption}
\newtheorem{void_thm}[thm]{}
\theoremstyle{liscio}
\newtheorem{void_def}[thm]{}
\newtheorem{remark}[thm]{Remark}
\newtheorem{notation}[thm]{Notation}
\newtheorem{note}[thm]{Note}
\newtheorem{exercise}[thm]{Exercise}
\newtheorem{example}[thm]{Example}
\setlength{\partopsep}{0mm}
\setlength{\topsep}{0mm}

\def\QED{\noindent\nolinebreak[4]\hspace{\stretch{1}}\rlap{\ \ $\Box$}\medskip}
\renewcommand\qedsymbol{\QED}
\renewcommand\proofname{\normalfont\textbf{Proof}}

\newenvironment{void}[1][]%
{\begin{trivlist}\item[\hskip\labelsep {\bf #1}]}
{\QED\end{trivlist}}

\pagestyle{plain}

\definecolor{violet}{RGB}{115, 0, 205}
\definecolor{brown}{RGB}{150, 50, 10}
\definecolor{green}{RGB}{5,110, 35}
\definecolor{emphcolor}{rgb}{.90,.98,.90}

\def\bl{\color{black}}
%\def\bl{\color{brown}}
\def\mr{\color{brown}}
\def\gr{\color{green}}
\def\vl{\color{violet}}

\def\mrA{{\mr\Aa}}
\def\mrB{{\mr\B}}
\def\mrC{{\mr\C}}
\def\mrD{{\mr\D}}
\def\mrE{{\mr\Ee}}
\def\mrG{{\mr\G}}
\def\mrU{{\mr\U}}
\def\mrV{{\mr\V}}
\def\mrS{{\mr\S}}
\def\mrP{{\mr\P}}
\def\mrW{{\mr\W}}
\def\grB{{\gr\B}}
\def\grC{{\gr\C}}
\def\grD{{\gr\D}}
\def\grV{{\gr\V}}

\renewcommand*{\emph}[1]{%
   \kern-0.2ex 
   \smash{\tikz[baseline]
   \node[ rectangle, fill=emphcolor, rounded corners, 
          inner xsep=.3ex, inner ysep=.2ex, anchor=base,
          minimum height = 3ex
         ]{#1};
   }
   \kern-1.2ex 
}

\begin{document}
\raggedbottom
\begin{center}
  {\huge\bfseries Scratch paper\\[3ex] \normalfont\normalsize
    Anonymous\vskip-1ex
    Università di Torino\vskip-1ex \monthname\ \the\year}
\end{center}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}

\bigskip\hfil
\parbox{0.9\textwidth}{
  \textbf{Abstract} \
  Poche idee, ben confuse.
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}\label{intro}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Abstract samples}\label{samples}
\def\medrel#1{\parbox[t]{6ex}{\hfil$#1$}}
\def\ceq#1#2#3{\parbox[t]{20ex}{$\displaystyle #1$}\medrel{\displaystyle #2}$\displaystyle  #3$}
\def\uuu{{\mathds 1}}
\def\Av{{\rm Av}}
\def\st{{\rm ft}}

Let $M$ be a structure of signature $L$.
%
The \emph{sample-expansion\/} of $M$ is a 3-sorted expansion $\<M,\omega,\bar M\>$, where $\bar M=M^{<\omega}$.
These three sorts are called \emph{home-sort,} \emph{integer-sort,} and \emph{sample-sort,} respectively.
The symbol \emph{$x$\/} always denotes a tuple of variables of the home-sort.
We put a bar over the symbols of sample-sort such as $\bar x$ and $\bar a$.
Symbols as $m,n,i$ are of integer-sort; from the context it should be inferred whether they are variables or parameters.

The \emph{size\/} of a sample $\bar a\in\bar M$ is the length of $\bar a$ as an element of $M^{<\omega}$.
This is denoted by \emph{$\lh\bar a$.}
We write \emph{$\bar a.i$\/} for the $i$-th element of the sample $\bar a$.
The same symbol $\bar a$ may be used for tuples of samples such as $\bar a_1,\dots,\bar a_n$.
Then by \emph{$|\bar a|$\/} we denote the length of this tuple (that is, $n$, for the tuple above).
We always make the the implicit assumption that all $\bar a_i$ in a tuple have the same size.
By this assumption, $\bar a.i$ is a well-defined element of $M^{|\bar a|}$.

The language of this expansion is denoted by $\barL$; it comprises
\begin{itemize}
  \item[1.] all symbols of $L$ that apply to the home-sort;
  \item[2.] $0,1,+,\cdot$ that apply to the integer-sort;
  \item[3.] a ternary relation of sort $\bar M,\omega, M$ that holds if $\bar x.i=y$;
  \item[4.] for every formula $\phi(x\,;y)\in\barL$, where $y$ a tuple of mixed sort, there is relation symbol for $\phi(\bar x.i\,;y)$, where $i$ is a variable of integer-sort.
\end{itemize}

When $\phi(x)$ is the formula $x=x$, requirement \ssf{4} implies that $\lh\bar x$ is definable.
By \ssf{2}, the cardinality of finite subsets of $\omega$ is definable.
Therefore, from \ssf{4}, it easily follows that the function $|\{i<\lh\bar a\, :\, \phi(\bar a.i)\}|$ is definable, uniformly in the parameters of $\phi(x)$.

As in the integer-sort we can interpret the field of rational numbers, below we will freely use rational numbers when this clarify the notation. 
For instance we define

\ceq{\hfill\Fr_{\bar a}\big[\phi(x)\big]}
{=}
{\frac{|\{i<\lh\bar a\, :\, \phi(\bar a.i)\}|}{\lh\bar a}}

and use that it is a definable function in $\barL$.
In particular we  will use that for every $s\in\QQ$ there is a formula saying $\Fr_{\bar a}\big[\phi(x)\big]\ge s$, uniformly in the parameter of $\phi(x)$.

\begin{definition}
  Let $\U$ be a monster model of inaccessible cardinality $\kappa>|L|$ and let $\<\U,\omega,\bar\U\>$ be the corresponding sample-expansion.
  %
  We denote by \emph{$\<\U,\omega^*,\bar\U^*\>$\/} a saturated elementary extension of $\<\U,\omega,\bar\U\>$ of cardinality $\kappa$.
  %
  Note that we can assume that the home-sort of this extension is $\U$, in fact as all saturated models of cardinality $\kappa$ are isomorphic.
  %
  The elements of $\bar\U$ are called \emph{finite samples,} those of $\bar\U^*$ are called \emph{internal samples.}
\end{definition}

To any internal sample $\bar a$ we associate a finitely additive measure on definable subsets of $\U^{|x|}$.
For $\phi(x)\in\barL(\U,\omega^*,\bar\U^*)$ we define 

\ceq{\hfill\Pr_{\bar a}\big[\phi(x)\big]}
{=}
{\sup\Big\{s\in\QQ\ :\ s<\Fr_{\bar a}\phi(x)\Big\}}

Note that this measure is type-definable, uniformly in the parameters of $\phi(x)$.
Namely, let $r\in\RR$ and $\phi(x\,;y)\in\barL$, where $y$ is a tuple of mixed sort.
Then there is a type $q(\bar x\,;y)\subseteq \bar L$ that defines $\Pr_{\bar x}\big[\phi(x\,;y)\big]\ge r$.

Let $M$ be a given model. 
By elementarity, for every $\epsilon>0$ and every formula $\phi(x)\in L(M,\omega,\bar M)$ there is an $\bar a'\in\bar M$ such that  

\ceq{\hfill\Pr_{\bar a}\big[\phi(x)\big]}
{\approx_\epsilon}
{\Fr_{\bar a'}\phi(x)}

Note that $\bar a$ need not have the same size of $\bar a'$.
In fact, in general $\lh\bar a$ may be non standard, while $\lh\bar a'\in\omega$.

\begin{definition}
  An \emph{external sample\/} is a global type $p(\bar x)\in S(\U,\omega^*,\bar\U^*)$ such that, for every formula $\phi(x)\in L(\U)$, the set $\{i\in\omega^*:p(\bar x)\proves\phi(\bar x.i)\}$ is bounded and definable; uniformly in the parameters of $\phi(x)$.\QED
\end{definition}

For every external sample $p(\bar x)$ there is an $n\in\omega^*$ such that $p(\bar x)\proves\lh\bar x =n$ and $\big|\{i\in\omega^*:p(\bar x)\proves\phi(\bar x.i)\}\big|$ is definable uniformly on the parameters of $\phi(x)$.

In analogy to what done with internal samples, we associate to an external sample $p(\bar x)$ a finitely additive probability measure on the definable subsets of $\U$.
Namely, we define

\ceq{\hfill\Pr_{\bar p}\big[\phi(x)\big]}
{=}
{\sup\bigg\{r\in\QQ\ :\ r<\frac{\big|\big\{i<\lh\bar x\ :\ p(\bar x)\proves\phi(\bar x.i)\big\}\big|}{\lh\bar x}\bigg\}}

What claimed above for internal samples, apply also to external samples, that is, there is a type $q(\bar x\,;y)\subseteq \barL$ that defines $\Pr_{\bar p}\big[\phi(x\,;y)\big]\ge r$.

\begin{notation}
  Let $z$ be a tuple of variables of the home-sort.
  For $p(\bar x)$ an external sample, $\phi(\bar x\,;z)\in\barL$, and $b\in\U^{|z|}$ we write \emph{$\phi(\bar p\,;b)$\/} for $p(\bar x)\proves\phi(\bar x\,; b)$.
  %
  We also write

  \ceq{\hfill\emph{$\phi(\bar p\,;\U)$}}{=}{\Big\{ b\in\U^{|z|}\ :\ \phi(\bar p\,;b)\Big\}}

  Sets of this form are called \emph{externally definable.}
  %
  This notation intentionally confuses $p(\bar x)$ with any of its realizations (suggestively denoted by $\bar p$) in some elementary extension of $\bar\U$.\QED
\end{notation}



\begin{definition}[(with warning)]\label{def_i}
  Let $z$ be a tuple of variables of the home-sort.
  Let $M$ be given.
  An external sample $p(\bar x)$ is
  \begin{itemize}
    \item[1.]\noindent\emph{invariant\/} over $M$ if for every formula $\phi(\bar x\,;z)\in\barL(M,\omega,\bar M)$ the set $\phi(\bar p\,;\U)$ is invariant over $M$;
    \item[2.]\noindent\emph{finitely satisfiable\/} in $M$ if every formula $\phi(\bar x)\in\barL(\U,\omega,\bar\U)$ in $p(x)$ is satisfied by some $\bar a\in\bar M$.
  \end{itemize}
  These notions are standard but for the important fact that only parameters in the home-sort are allowed.\QED
\end{definition}

It is clear that satisfiable implies invariant.

% Note that in \ssf{2} above the requirement $\bar a\in\bar M$ entails in particular $\lh\bar a\in\omega$.

If an external sample $p(\bar x)$ is weakly satisfiable in $\bar M$ then for every $\epsilon>0$ and every formula $\phi(x)$ there is an $\bar a\in\bar M$ such that  

\ceq{\hfill\Pr_{\bar p}\big[\phi(x)\big]}
{\approx_\epsilon}
{\Fr_{\bar a}\phi(x)}

Let $p(\bar x)$ external sample finitely satisfiable in $M$.
A coheir sequence in  $p(\bar x)$ is sequence $\<\bar a_i:i<\omega\>$ such that

\ceq{\hfill\psi(x\,;b_1,\dots,b_n)}
{\imp}
{\big[\phi(a\,; b)\ \iff\ \phi(x\,; b)\big]}

\section{Distal formulas}

The formula $\phi(x\,;z)\in L$ is \emph{distal\/} if there is a formula $\psi(x\,;z_1,\dots,z_n)\in L$ such that for every finite set $B\subseteq\U^{|z|}$ of cardinality at least $2$ and every $a\in\U^{|x|}$ there are some $b_1,\dots,b_n\in B$ such that $\psi(a\,;b_1,\dots,b_n)$ and
    
\ceq{\hfill\psi(x\,;b_1,\dots,b_n)}
{\imp}
{\big[\phi(a\,; b)\ \iff\ \phi(x\,; b)\big]}
\hfill for all $b\in B$.

% \begin{proposition}
%   The following are equivalent
%   \begin{itemize}
%     \item[1.] $\phi(x\,;z)$ is distal;
%     \item[2.] there are two formulas $\eta_i(z_1,\dots,z_n\,;z)$, where $i=0,1$, such that for every $a\in\U^{|x|}$ there is a tuple $b_1,\dots,b_n\in B$ such that $\phi(a\,;B)=\eta_i(b_1,\dots,b_n\,;B)$ and 
    
%     \hfil$\eta_0(b_1,\dots,b_n\,;z)\ \imp\ \phi(a\,;z)\ \imp\ \eta_1(b_1,\dots,b_n\,;z)$.
% \end{itemize}
% \end{proposition}
\end{document}

As usual, finite satisfiability implies invariance.

\begin{fact}
  Let $M$ be given.
  %
  Let $p(\bar x)$ be a finitely satisfiable external sample.
  %
  Then $p$ is invariant.\QED
\end{fact}

\begin{definition}\label{def_ufs}
  Let $M$ be given.
  %
  A external sample $p(\bar x)$ is \emph{uniformly satisfiable\/} if for every $\phi(\bar x;z)\in\barL(\bar M)$ there is an $r\subseteq M^{\rm s}$ such that $\phi(p\,;b)\iff\phi(r\,;b)$ for every $b\in\U^{|z|}$.\QED
\end{definition}

Note that uniform satisfiability implies definability.

\begin{definition}\label{def_smooth_global}
  Let $M$ be given.
  %
  An external sample is \emph{smooth\/} if it is invariant and realized in $\bar\U^*$ (by some internal sample).\QED
\end{definition}

\begin{lemma}\label{lem_sus}
  Let $M$ be given.
  %
  Then every smooth external sample $p(\bar x)$ is uniformly satisfiable.
\end{lemma}

\begin{proof}
  Let $s\in\bar\U^{\rm s*}$ be an internal sample that realizes $p(\bar x)$.
  %
  Let $\phi(\bar x;z)\in L$ be given.
  %
  Firstly, note that $\phi(p\,;\U)=\phi(s\,;\U)$ is definable in $\bar\U^*$ hence, by invariance, it is definable in $\bar M$.
  
  Secondly, we prove that $p(\bar x)$ is finitely satisfiable.
  %
  Let $b\in\U^{|z|}$ be given and pick $b'\equiv_{\bar M}b$ be such that $s\cnonfork_{\bar M}b'$.
  %
  By invariance, $\phi(s\,;b')\iff\phi(s\,;b)$.
  %
  Therefore there is an $r\in M^{\rm s}$ such that $\phi(r\,;b')\iff\phi(s\,;b)$.
  %
  This proves finite satisfiability.
  %
  By finite satisfiability, the following type is inconsistent
  
  \ceq{\hfill q(z)}{=}{\bigg\{\phi(s\,;z)\niff\phi(r\,;z)\ :\ r\in M^{\rm s}\bigg\}}

  Hence compactness yields some finitely many $r_i\subseteq M^{\rm s}$ such that
  
  \ceq{\hfill \A z}{\bigvee^n_{i=1}}{\big[\phi(s\,;z)\iff\phi(r_i\,;z)\big]}

  By the definability of $p(\bar x)$, which we proved in \ssf{1}, there are some formulas $\theta_i(z)\in L(\bar M)$ equivalent to $\phi(s\,;z)\iff\phi(r_i\,;z)$.
  %
  Hence we have

  \ceq{\hfill \A z}
  {\bigwedge^n_{i=1}}
  {\Big[\theta_i(z)\iff\big[\phi(s\,;z)\iff\phi(r_i\,;z)\big]\Big]}

  By elementarity, there is an $r\in M^{\rm s}$ such that the formula above holds with $s$ replaced by $r$.
  %
  Therefore $\A z\,\big[\phi(s\,;z)\iff\phi(r\,;z)\big]$. 
  %
  Hence $r$ is as required by Definition~\ref{def_ufs}.
\end{proof}




%Note that a external sample $p(\bar x)$ is finitely satisfiable if for every finite many $b_i\subseteq\U^{|z|}$ there is an $r\in M^{\rm s}$ such that $\phi(p\,;b_i)\iff\phi(r\,;b_i)$ for all $i$.


Let  $p(\bar x)$ be a external sample. The \emph{support\/} of $p(\bar x)$  is the set of those $a\in\U^{|x|}$ such that $p(\bar x)\proves \bar x(a)\neq0$.

\begin{lemma}\label{lem_finsupp}
  Let $M$ be given.
  %
  Let $p(\bar x)$ be a uniformly satisfiable external sample.
  %
  Then the support of  $p(\bar x)$ is a finite subset of $M$.
\end{lemma}

\begin{proof}
  Apply Definition~\ref{def_ufs} to the formula $\bar x(z)\neq0$.
  %
  Then there is an $r\in M^{\rm s}$ such that for every $b\in\U^{|z|}$.

  \ceq{\hfill p(\bar x)}{\proves}{\bar x(b)\neq0\imp r(b)\neq0.}

  As $r$ has finite support, the lemma follows.
\end{proof}

\begin{fact}\label{fact_finite_support}
  Let $M$ be given.
  %
  Let $p(\bar x)$ be a global type with a finite support enumerated by the tuple $a$.
  %
  Then  there is type $q(y)$, where $y$ is a tuple of variables of real-sort of length $|a|$, with parameters in $\U,\bar M$ and no variable of sample-sort such that

  \ceq{\hfill p(\bar x)}
  {\iff}
  {\E y\ \Big[ q(y)\ \cup\ \{\bar x(a)=y\}\Big]}
\end{fact}

\begin{proof}
  
\end{proof}


\begin{lemma}
  Let $M$ be given.
  %
  Let $p(\bar x)$ be a global type, then the following are equivalent
  \begin{itemize}
    \item[1.] $p(\bar x)$ is smooth;
    \item[2.] $p(\bar x)$ is uniformly satisfiable.
  \end{itemize}
\end{lemma}

\begin{proof}
  Implication \ssf{1}$\IMP$\ssf{2} has been proved in Lemma~\ref{lem_sfs}. 
  %
  Here we prove \ssf{2}$\IMP$\ssf{1}. 
  %
  By Lemma~\ref{lem_finsupp},  $p(\bar x)$ has a finite support $A\subseteq M$.   
  %
  Now apply Fact~\ref{fact_finite_support}.
  %
  As the type $q(y)$ is relized in $\bar\U^*$, so is  $p(\bar x)$.
  %
  Invariance is clear by finite satisfiability.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Erd\H os-Hajnal property}\label{samples}

Let $\phi(x\,;z)\in L$. We say that $\phi(x\,;z) $ has the \emph{Erd\H{o}s-Hajnal property\/} if there is a constant $\delta\in(0,1)$, which depends soley on $\phi(x\,;z)$, such that for every finite $A\subseteq\U^{|x|}$ and $B\subseteq\U^{|z|}$ there are $A_0\subseteq A$ and $B_0\subseteq B$ such that $|A_0|>\delta|A|$, \ $|B_0|>\delta|B|$ and $A_0\times B_0$ is either disjoint from or contained in $\phi(\U\,;\U)$.

\begin{definition}
  We say that  $\phi(x\,;z)\in L$ is a \emph{distal\/} formula if there are some formulas $\eta_i(z\,;\bar z)\in L$, where $i=0,1$ and $|\bar z|=n{\cdot}|z|$ for some $n$, such that for every $a\in\U^{|x|}$ and every finite set $B\subseteq\U^{|z|}$ there is a tuple $\bar b\in B^n$ such that $\phi(a\,;B)=\eta_i(B\,;\bar b)$ and $\eta_0(z\,;\bar b)\imp\phi(a\,;z)\imp\eta_1(z,\bar b)$.
\end{definition}

\begin{theorem}
  Assume $\eta(x\,;z)\in L$ has {\sc vc}-dimension $k<\infty$. Then for every $\epsilon>0$ and every finite $B\subseteq\U^{|z|}$ there is a $B_0\subseteq B$ of cardinality $<(k/\epsilon^2)\ln(k/\epsilon)$.
\end{theorem}

\begin{theorem}[(Chernikov-Starchenko)]
  Assume $T$ is nip.
  %
  Then every distal formula has the Erd\H{o}s-Hajnal property.
\end{theorem}

\begin{proof}
  Let $\psi(x\,;\bar z)$ be the formula given by distality.
  %
  Write $\theta(z\,;\bar z)$ for the formula

  \hfil$\A x\ \big[\psi(x\,;\bar z)\imp\phi(x\,;z)\big]\ \vee\ \A x\ \big[\psi(x\,;\bar z)\imp\neg\phi(x\,;z)\big]$.

  Let $s\in\U^{\rm s}$ be the indicator function of $A$. 
  %
  Let $\bar b\in\U^{|\bar z|}$ be such that $\psi(s\,;\bar b)>\epsilon$.
\end{proof}

\begin{proposition} 
  Let $\phi(x\,;z)\in L$ be given.
  %
  Below, we write $\bar z$ for the tuple of variables $z_1,\dots,z_n$, where $|z_i|=|z|$.
  %
  The following are equivalent
   \begin{itemize}
    \item[1.] there is a formula $\psi(x\,;\bar z)\in L$ such that for every finite set $B\subseteq\U^{|z|}$ and every $a\in\U^{|x|}$ there is a $\bar b\in B^n$ such that $\psi(a\,;\bar b)$ and $\psi(x\,;\bar b)$ decides all formulas $\phi(x\,; b)$ for $b\in B$;
    \item[2.] there are two formulas $\eta_i(z\,;\bar z)$, where $i=0,1$, such that for every $a\in\U^{|x|}$ there is a $\bar b\in B^n$ such that $\phi(a\,;B)=\eta_i(B\,;\bar b)$ and $\eta_0(z\,;\bar b)\imp\phi(a\,;z)\imp\eta_1(z,\bar b)$.
  \end{itemize}
\end{proposition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Recycle bin}

Below, $\epsilon$ always ranges over the positive standard reals.
%
If $a$ and $b$ are (hyper)reals, we write \emph{$a\approx_\epsilon b$\/} for $|a-b|<\epsilon$.
%
We write \emph{$a\approx b$\/} if $a\approx_\epsilon b$ holds for every $\epsilon$.


\begin{lemma}
  Let $M$ be given.
  %
  Let $p(x^{\rm s})$ be smooth.
  %
  Then for every $\epsilon$ there are finitely many formulas $\theta_i(x)\in L(M)$ such that for every $b\in\U^{|z|}$ we have $\theta_i(x)\imp\phi(x\,;b)\imp\theta_j(x)$ and $\Fr\theta_i(p)\approx_\epsilon\Fr\theta_j(p)$ for some $i,j$.
\end{lemma}

\begin{proof}


\end{proof}
%
Then for every $b\in\U^{|z|}$ there is an $r\in R$

\ceq{\hfill p(x^{\rm s})}{\proves}{x^{\rm s}(b)>0\iff r(b)>0} such that

As 
Write $\supp(R)$ for the union of $\supp(r)$ for $r\in R$.
%
Then $p\proves \supp(x^{\rm s}) \subseteq \supp(R)$.
%
In particular $p\proves \supp(x^{\rm s}) = A$ for some finite $A\subseteq M$.
%


$\phi(p\,;z) \iff r(z)>0$

% We assume that for every $\phi(x),\phi(x)\in\barL(\bar\U)$ if $\phi(x)\imp\phi(x)$ then $\sbar\phi(x^{\rm s})\le\sbar\phi(x^{\rm s})$.





Let $p(x^{\rm s})$ be external sample that is uniformly finitely satisfiable w.r.t.\@ all $\phi(x^{\rm s}\,;z)\in L$.
%
Then there is an $r\in M^{\rm s}$ such that 

$x^{\rm s}(z_i)\approx_\epsilon\mu_i$




\begin{fact}
  Let $M$ and $\phi(x\,;z)\in L$ be given.
  %
  Let $p(x^{\rm s})$ be a definable, uniformly finitely satisfiable external sample.
  %
  Then there are finitely many formulas $\theta_i(x)\in L(M)$ such that for every $b\in\U^{|z|}$ we have $\theta_i(x)\imp\phi(x\,;b)\imp\theta_j(x)$ and $\sbar\theta_i(p)\approx_\epsilon\sbar\theta_j(p)$ for some $i,j$.
\end{fact}

\begin{proof}
  Let $\psi_r(z)$, for $r\in R\subseteq M^{\rm s}$

  Let 


  Pick finite $F\subseteq\RR$ such that for every $b$ we have $\sbar\phi(p\,;b)\approx_{\epsilon}\mu$ for some $\mu\in F$.
  %
  By Definition~\ref{def_ssf} there is a finite set $R\subseteq M^s$ such that for every $b\in\U^{|z|}$ and every $\mu\in F$ we have $\phi(p\,;b)\approx_{\epsilon}\mu\ \iff\ \phi(r\,;b)\approx_{\epsilon}\mu$ for some $r\in R$.
  %
  Therefore for every $b\in\U^{|z|}$ we have that $\phi(p\,;b)\approx_{2\epsilon}\phi(r\,;b)$ for some $r\in R$.
  %
  Let $A\subseteq\U^{|z|}$ be a finite set containing $\supp(r)$ for all $r\in R$. 
  %
  Let $\theta_i(x)$ enumerate the formulas $x\in B$ and $x\notin B$, as $B$ ranges over the subsets of $A$.
  
  We prove that these formulas are as required by the proposition.
  %
  Fix some $b\in\U^{|z|}$ and let $r\in R$ be such that $\phi(p\,;b)\approx_{2\epsilon}\phi(r\,;b)$.
  %
  Let

  \ceq{\hfill B_0}
  {=}
  {\{a\in\supp(r) : \phi(a\,;b)\}}
  
  \ceq{\hfill B_1}
  {=}
  {\{a\in\supp(r) : \neg\phi(a\,;b)\}}

  Clearly, $x\in B_0\imp \phi(x\,;b)\imp x\notin B_1$.
\end{proof}

\begin{definition}
  Let $\phi(x^{\rm s}\,;z)\in L$ and $M$ be given.
  %
  We say that $p(x^{\rm s})$ is \emph{weakly approximable\/} if there are some finitely many $r_i\in M^{\rm s}$, say $0\le i<n$, such that for every $b\in\U^{|z|}$ we have $\phi(p\,;b)\iff\phi(r_i\,;b)$ for some $i$.\QED
\end{definition}

Let $\phi(x\,;z)\in L$ and $M$ be given.
%
Let $\B=\phi(p;\U)$.
%
Let $p(x^{\rm s})$ be weakly approximable. Then there is a finite cover of $\B$, say $\B_1,\dots,\B_n$, such that all the types $p_i(x)=\{\phi(x\,;b):b\in\B_i\}$ are consistent.


\begin{fact}
  Let $M$ be given.
  %
  Let $p(x^{\rm s})$ be external sample.
  %
  Suppose for every $\phi(x)\in L(\U)$ and $\epsilon$ there are $\theta_1(x), \theta_2(x)\in L(M)$ such that $\theta_1(x)\imp\phi(x)\imp\theta_2(x)$ and $\sbar\theta_2(p)\approx_\epsilon\sbar\theta_1(p)$.
  %
  Then $p$ is finitely satifiable.
\end{fact}

\begin{proof}
  Let $\phi_i(x)$, for $0\le i<n$, be given.
  %
  We claim that there is an $r\in \bar M$ such that $\sbar\phi_i(p)\approx_{3\epsilon}\sbar\phi_i(r)$ for every $i$.

  Let $\theta_{i,1}(x)$ and $\theta_{i,2}(x)$ be as in the fact.
  %
  As $\theta_{i,1}(p)\le\phi_i(p)\le\theta_{i,2}(p)$, then $\theta_{i,1}(p)\approx_\epsilon\phi_i(p)$.
  %
  By elementarity there is an $r\in \bar M$ such that $\theta_{i,1}(r)\approx_\epsilon\theta_{i,1}(p)$ and $\theta_{i,2}(r)\approx_\epsilon\theta_{i,2}(p)$.
  %
  Then the claim follows immediately.
\end{proof}





\begin{lemma}
  The following are equivalent for every external sample $p(x^{\rm s})$
  \begin{itemize}
    \item[1.] $p$ is smooth and invariant;
    \item[2.] for every finite $B\subseteq\U^{|z|}$ and every $\epsilon$, there is an $r\in \bar M$ such that $\sbar\phi(p\,;b)\approx_\epsilon\sbar\phi(r\,;b)$ for all $b\in B$;
    \item[2.] for every $\phi_i(x\,;z)\in L$, every $b_i\in\U^{|z|}$, and every $\epsilon$, there is an $r\in \bar M$ such that $\sbar\phi_i(p\,;b_i)\approx_\epsilon\sbar\phi_i(r\,;b_i)$, for every $0\le i<n$;
    \item[2.] for every $\psi_0(x),\dots,\psi_{n-1}(x)\in L(\U)$ and every $\epsilon$, there is an $r\in \bar M$ such that $\sbar\psi_i(p)\approx_\epsilon\sbar\psi_i(r)$, for every $i<n$;
    \item[4.] there are finitely many formulas $\theta_i(x)\in L(M)$ such that for every $b\in\U^{|z|}$ we have that $\theta_i(x)\imp\phi(x\,;b)\imp\theta_j(x)$ and $\sbar\theta_j(p)-\sbar\theta_i(p)<\epsilon$ for some $i,j$.
  \end{itemize}
\end{lemma}

\begin{proof} Let $s$ be an internal sample that realizes $p(x^{\rm s})$.

  \ssf{1}$\IMP$\ssf{2}.
  %
  Let $B$ and $\epsilon$ be given.
  %
  Let $\bar b=\<b_i:i<n\>$ be an enumeration of $B$.
  %
  Let $\mu_i\in\RR$ be such that $\sbar\phi(p\,;b_i)\approx\mu_i$ for every $i<n$.
  %
  Let $\bar b'$ be such that $s\cnonfork_{\bar M}\bar b'\equiv_{\bar M}\bar b$.
  %
  By invariance, $\sbar\phi(s\,;b'_i)\approx\mu_i$.
  %
  Therefore there is an $r\in \bar M$ such that $\sbar\phi(r\,;b'_i)\approx_\epsilon\mu_i$ for every $i<n$.
  %
  As $\bar b'\equiv_{\bar M}\bar b$, we obtain  $\sbar\phi(r\,;b_i)\approx_\epsilon\mu_i$.


  \ssf{1}$\IMP$\ssf{2}.
  Let $\psi_i(x)=\phi_i(x\,;b_i)$ for some $\phi_i(x\,;z)\in L$ and  $b_i\in\U^{|z|}$.
  %
  Let $\bar b=\<b_i:i<n\>$.
  %
  Let $\mu_i\in\RR$ be such that $\sbar\phi_i(p\,;b_i)\approx\mu_i$.
  %
  Let $\bar b'$ be such that $s\cnonfork_{\bar M}\bar b'\equiv_{\bar M}\bar b$.
  %
  By invariance, $\sbar\phi_i(s\,;b'_i)\approx\mu_i$.
  %
  Therefore there is an $r\in \bar M$ such that $\sbar\phi_i(r\,;b'_i)\approx_\epsilon\mu_i$ for every $i<n$.
  %
  As $\bar b'\equiv_{\bar M}\bar b$, we obtain  $\sbar\phi_i(r\,;b_i)\approx_\epsilon\mu_i$.


  \ssf{1}$\IMP$\ssf{3}.
  %
  By smoothness we it suffices to prove \ssf{3} with $s$ for $p$.
  %
  The type

  \ceq{\hfill p(z)}{=}{\Big\{\sbar\phi(s\,;z)\not\approx_\epsilon\sbar\phi(r\,;z)\ :\ r\in \bar M\Big\}}

  is inconsistent by \ssf{2}.
  %
  Hence compatness yields the required $r_1,\dots,r_n\in \bar M$.

  \ssf{3}$\IMP$\ssf{2}. Clear.

  \ssf{2}$\IMP$\ssf{1} Assume \ssf{2}.
  %
  We prove that $p$ is invariant.
  %
  Pick some $b\equiv_{\bar M}b'$ and some $\epsilon$.
  %
  Let $r,r'\in \bar M$ be such that $\sbar\phi(p\,;b)\approx_\epsilon\sbar\phi(r\,;b)$ and $\sbar\phi(p\,;b')\not\approx_\epsilon\sbar\phi(r';b')$.
  %
  As $\sbar\phi(r\,;b)\approx\sbar\phi(r';b')$ follows from  $b\equiv_{\bar M}b'$, we obtain $\sbar\phi(p\,;b)\approx_\epsilon\sbar\phi(p\,;b')$.

  We prove that $p$ is smooth.

  \ceq{\hfill p(x^{\rm s})}{=}{\Big\{\sbar\phi(x^{\rm s};b)\approx_\epsilon\mu_b\ :\ b\in\U^{|z|}\Big\}}
\end{proof}

%Clearly, if $s$ is an internal sample, then $p(x^{\rm s})=\tp(s/\bar\U)$ is a smooth sample w.r.t.\@ any given formula $\phi(x\,;z)\in L$.

\begin{definition}\label{def_genstable}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  A external sample $p(x^{\rm s})$ is
  \begin{itemize}
    \item[1.]\noindent \emph{invariant\/} if $\bar\phi(p\,;b)\approx\bar\phi(p\,;b')$ for every $b\equiv_{\bar M}b'$;
    \item[2.]\noindent (pointwise) \emph{approximable\/} if, for every $b\in\U^{|z|}$ and every $\epsilon$, there is an $r\in \bar M$ such that $\sbar\phi(p\,;b)\approx_\epsilon\sbar\phi(r\,;b)$;
    \item[3.]\noindent \emph{definable\/} if, for every $\epsilon$, the set $\{b\in\U^{|z|}:\sbar\phi(p\,;b)<\epsilon\}$ is definable over $\bar M$.\QED
  \end{itemize}
\end{definition}




The following is a useful characterization of smooth samples.


\section{Old stuff/garbage}


%
We write \emph{$\supp(p)$\/} for the \emph{support\/} of $p$, that is, the set of those $a$ in $\U$ such that $p\proves (a\in x^{\rm s})>\epsilon$ for some standard positive $\epsilon$.
%
If $s$ is a smooth sample  \emph{$\supp(s)$\/} is defined to be  \emph{$\supp(p)$\/} for $p(x^{\rm s})=\tp(s/\bar\U)$.



% \begin{definition}[???]
%   We say that $\U$ is \emph{pseudofinite\/} every definable set is the support of a sample.\QED
% \end{definition}

Let $s$ be an external sample.
%
For every formula $\phi(x\,;z)\in L$ and every $b\in\U^{|z|}$ we define

\ceq{\hfill\emph{$\Av_{x/s}\phi(x\,;b)$} }
{=}
{\frac{\big|\big\{a\in s\ :\ \phi(a\,;b)\big\}\big|}
  {|s|}},

When possible we abbreviate $\Av_{x/s}\phi(x\,;b)$ with \emph{$\sbar\phi(s\,;b)$}.
%
%If we pretend that hyperrational are elements of $\U^{\rm f^+_*}$, then $\sbar\phi(s\,;b)$, as a function of $s$ and $b$, is definable in $\U^{\rm f^+_*}$.

%
We write $\st(a)$, for the standard part of the hyperrational number $a$.
%
That is, the unique real number $\mu$ such that $\mu\approx a$.

The standard part of $\Av_s$ induces a finite probability measure on the algebra of definable subsets of $\U^{|x|}$.
%
This measure has an unique extension to a Lebesgue probability measure on a $\sigma$-algebra.
%
This is known as the \emph{Loeb measure.}


All definitions and facts in this section are relative to some given formula $\phi(x\,;z)\in L$ and some model $M$.

\begin{definition} Let $\phi(x\,;z)\in L$ and $M$ be given. We say that a sample $s$ is \emph{smooth\/} if, for every $s'\equiv_Ms$ and every $b\in\U^{|z|}$, we have $\sbar\phi(s';b)\approx\sbar\phi(s\,;b)$.\QED
\end{definition}

\begin{definition}\label{def_genstable}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  An external sample $s$ is
  \begin{itemize}
    \item[1.]\noindent \emph{invariant\/} if, for every $b,b'\in\U^{|z|}$ such that $b\equiv_Mb'$, we have $\sbar\phi(s\,;b)\approx\sbar\phi(s\,;b')$;
    \item[2.] \noindent \emph{definable\/} if, for every $\epsilon$, the set $\{b\in\U^{|z|}:\sbar\phi(s\,;b)<\epsilon\}$ is definable over $M$;
          % \item [3.]\noindent  \emph{satisfiable\/} if, for all $b\in\U^{|z|}$, if $\sbar\phi(s\,;b)>\epsilon$, then  $\phi(r\,;b)>\epsilon$ for some $r\in \bar M$.
    \item [3.]\noindent  \emph{finitely satisfiable\/} if, for all $b\in\U^{|z|}$ there is an $r\in \bar M$ such that  $\sbar\phi(s\,;b)\approx_\epsilon\sbar\phi(r\,;b)$;
    \item[4.] \noindent  \emph{generically stable\/} if all of the above hold.\QED
  \end{itemize}
  %When $\phi(x\,;z)$ and $M$ are not clear from the context we add: \emph{for $\phi(x\,;z)$ over/in $M$.}
\end{definition}

Smooth roughly means internal and invariant.

\begin{fact}\label{fact_smoothinternalinvariant}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  The following are equivalent for every external sample $s$

  \begin{itemize}
    \item[1.] $s$ is smooth;
    \item[2.] there is an invariant internal sample $s'\equiv_Ms$.
  \end{itemize}
\end{fact}

\begin{proof}
  \ssf{1}$\IMP$\ssf{2}.
  %
  Let $s$ be smooth and let $s'\equiv_Ms$ be any internal sample.
  %
  If $b,b'\in\U^{|z|}$ and $b\equiv_Mb'$, then $b'=fb$ for some $f\in\Aut(\bar\U^*/M)$.
  %
  Then $\sbar\phi(s';fb)\approx\sbar\phi(f^{-1}s'\,;b)$.
  %
  Moreover, by smothness $\sbar\phi(f^{-1}s'\,;b)\approx\sbar\phi(s';b)$. The infariace in $s'$ follows.

  \ssf{2}$\IMP$\ssf{1}.
  %
  It suffices to prove that if $s$ is internal and invariant then it is smooth.
  %
  Suppose for a contradiction that there is an $s'\equiv_Ms$ such that $\sbar\phi(s'\,;b)\not\approx_\epsilon\sbar\phi(s\,;b)$.
  %
  Pick a internal sample $s''\equiv_{M,s}s'$.
  %
  Then $\sbar\phi(s''\,;b)\not\approx_\epsilon\sbar\phi(s\,;b)$.
  %
  As $s''\equiv_Ms$ are both in $\bar\U^*$, then $s''=fs$ for some $f\in\Aut(\bar\U^*/M)$.
  %
  Hence we obtan $\sbar\phi(s\,;f^{-1}b)\not\approx_\epsilon\sbar\phi(s\,;b)$ which contradics the invariance of $s$.
\end{proof}


\begin{definition}\label{def_approximable_sample}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  Let $\B\subseteq\U^{|z|}$ be arbitrary.
  %
  We say that $s$ is \emph{(uniformly) approximable\/} on $\B$ if for every $\epsilon$ there is a finite sample $r\in \bar M$ such that $\sbar\phi(s,b)\approx_\epsilon\sbar\phi(r,b)$ for every $b\in\B$. (The sample $r$ depends on $\epsilon$, not on $b$.)\QED
\end{definition}

\begin{lemma}\label{lem_cons}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  Let $s$ be approximable on $\B$ and such that $\sbar\phi(s\,;b)>\epsilon$ for every $b\in\B$. Then there is a finite cover of $\B$, say $\B_1,\dots,\B_n$, such that all the types $p_i(x)=\{\phi(x\,;b):b\in\B_i\}$ are consistent.
\end{lemma}

\begin{proof}
  Let $r\in \bar M$ be as in Definition~\ref{def_approximable_sample}.
  %
  As $r$ is finite, we may assume that $\supp(r)=\{a_1,\dots,a_n\}$.
  %
  Let $\B_i=\{b\in\B:\phi(a_i\,;b)\}$.
  % 
  As $\sbar\phi(r\,;b)>0$ for all $b\in\B$, these $\B_i$ are the required cover of $\B$.
\end{proof}

\begin{corollary}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  If $s$ be approximable on $\<b_i:i<\omega\>$, where $\<b_i:i<\omega\>$ is a sequence of indiscernibles such that $\sbar\phi(s\,;b_i)>\epsilon$ for every $i<\omega$, then the type $\{\phi(x\,;b_i):i<\omega\}$ is consistent.\QED
\end{corollary}

\begin{corollary}
  Let $\phi(x\,;z)\in L$ and $M$ be given.
  %
  Let $s$ be approximable on $\C$.
  %
  Then for every $\epsilon$ there is a pair of distict $c,c'\in\C$ such that $\Av_{x/s}\big[\phi(x\,;c)\niff\phi(x\,;c')\big]<\epsilon$
\end{corollary}

\begin{proof}
  Suppose for a contradiction that $\Av_{x/s}\big[\phi(x\,;c)\niff\phi(x\,;c')\big]\ge\epsilon$ for all distict $c,c'\in\C$. Apply Lemma~\ref{lem_cons} to the folmula $\psi(x\,;z,z') = [\phi(x\,;z)\niff\phi(x\,;z')]$ and the set $\B=\{\<c,c'\>\in\C^2\, :\, c{\neq} c'\}$.
  %
  The sets $\B_i$ obtained from Lemma~\ref{lem_cons} induce a finite coloring of the complete graph on $\C$.
  %
  By the Ramsey theorem there is an infinite monochromatic set $A\subseteq\C$.
  %
  Hence $\{\phi(x\,;a)\niff\phi(x\,;a')\  :\  a,a'{\in} A,\ a{\neq} a'\}$ is consistent.
  %
  As $|A|>2$, this is impossible.
\end{proof}


% The following is stronger form of invariance.


% \begin{definition}
%   Let  $\phi(x\,;z)\in L$.

%   We say that a sample $s$ of $M^{|x|}$ is $\phi$-smooth over $M$ if there is a finite $S\subseteq M^{|x|}$ such that $\sbar\phi(s\,;b)\approx\sbar\phi(s\,;b)$ for all $b\in M^{|z|}$.
%   We say that an external sample $s$ is \emph{smooth\/} for $\phi(x\,;z)$ over $M$ if for any other sample $s'$ such that $\sbar\phi(s\,;b)\approx\sbar\phi(s';b)$ for all $b\in M^{|z|}$, the same equivalence holds for all $b\in\U^{|z|}$.\QED
% \end{definition}

% Clearly, smooth impies invariant.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The nip formulas}\label{nip}

\begin{theorem}\label{thm_VC}
  Let $\phi(x\,;z)\in L$ and $M$ be given and assume that $\phi(x\,;z)$ is nip.
  %
  Then every sample is approximable on $M$ over $M$.
\end{theorem}

\begin{proof}
  Questo è Vapnik-Chervonenkis.
\end{proof}

For smooth samples the Vapnik-Chervonenkis Theorem can be strengthened as follows. (The difference is that below $b$ ranges over $\U^{|z|}$.)

\begin{corollary}
  Let  $\phi(x\,;z)\in L$ be nip.
  %
  Every smooth sample $s$ is approximable on $\U$ over $M$.
\end{corollary}

\begin{proof}
  By Theorem~\ref{thm_VC}, there is an $r\in \bar M$ such that $\sbar\phi(s\,;b)\approx_\epsilon\sbar\phi(r\,;b)$ for all $b\in M^{|z|}$.

  Suppose for a contradiction that $\sbar\phi(s\,;b')\not\approx_\epsilon\sbar\phi(r\,;b')$ for some $b'\in\U^{|z|}$.
  %
  Pick a  $s'\subseteq\U^{|x|}$ such that $b'\cnonfork_{M}s'\equiv_Ms$.
  %
  By the smoothness of $s$, we obtain $\sbar\phi(s';b')\not\approx_\epsilon\sbar\phi(r\,;b')$.
  %    
  As $b'\cnonfork_{M}s'$, the same formula holds for some $b\in M^{|z|}$.
  %
  Once again by smoothness, $\sbar\phi(s\,;b)\not\approx_\epsilon\sbar\phi(r\,;b)$.
  %
  A contradiction.
\end{proof}

\begin{definition}[??]
  We say that $\phi(x\,;z)\in L$ is \emph{distal\/} if there is a formula $\psi(x\,;z_1,\dots z_n)\in L$ such that for every finite set $B\subseteq\U$ and every $a\in\U^{|x|}$ there are $b_1,\dots,b_n\in B$ such that $\psi(a\,;b_1,\dots,b_n)$ and $\psi(x\,;b_1,\dots,b_n)$ decides all formulas $\phi(x\,; b)$ for $b\in B$.\QED
\end{definition}

\begin{definition}[??*]
  We say that $\phi(x\,;z)\in L$ is \emph{distal\/} if there is a formula $\psi(x_1,\dots,x_n\,;z)\in L$ such that for every finite set $A\subseteq\U^{|x|}$ and every $b\in\U^{|z|}$ there are $a_1,\dots,a_n\in A$ such that $\psi(a_1,\dots,a_n,\;z)$ and $\psi(a_1,\dots,a_n,\,z)$ decides all formulas $\phi(a\,; z)$ for $a\in A$.\QED
\end{definition}

For every finite sample $r\in \bar M$ and every $\mu\in\RR$ there is a formula $\psi(z)\in L(\supp r)$ such that $\sbar\phi(r\,;z)=\mu \iff \psi(z)$. The formula $\psi(z)$ depends on $r$.

When $\phi(x\,;z)$ is distal

If  $\phi(x\,;z)$ is distal then there is a formula $\psi$ such that  for every $r\in M^f$ there is $r_0\in M^{}$

\begin{theorem}[(false)]
  The following are equivalent
  \begin{itemize}
    \item[1.] $\phi(x\,;z)\in L$ is distal;
    \item[2.] for every sample $s\in\U^{\rm f^+_*}$, if $s$ is generically stable then $s$ is smooth.

  \end{itemize}
\end{theorem}

There is a formula $\psi(x_1,\dots,x_n\,;z)$ such that for every $r\in \bar M$

there are $a_1,\dots,a_n$ such that $\phi(r\,;b)=\mu$ $\psi(x_1,\dots,x_n\,;z)$


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
We say that $p(x)$ is honestly definable if for every $\varphi(x,y)\in L$ there is a formula $\psi(y,z)\in L$ such that for every finite $A$, there is a $b$ such that

$$A\subseteq\psi(\U,b)\subseteq \phi(p,\U)$$

For $\varphi(x,y)\in L$ and $m\in M$ let 

$$\varphi_m(x,y)\quad=\quad\varphi(m,y)\leftrightarrow\varphi(x,y)$$

$$A \subseteq\psi_{m,\phi}({\cal U})\subseteq \phi_m(p,\U)$$

If $p(x)$ is generically stable (definition as in the OP) then for every $\varphi(x,y)\in L$ and $m\in M$ there is a formula $\vartheta_{\varphi,m}(y)$ such that for every $a$ in the monster model

$$\vartheta_{\varphi,m}(a)\quad\Leftrightarrow\quad[\varphi(m,a)\leftrightarrow\varphi(x,a)]\in p$$

Let $q(x)$ be an $M$-invariant global type such that  $q_{\restriction M}(x)=p_{\restriction M}(x)$. Then both $q$ and $p$ contain the formulas

$$\A y\ \Big[\vartheta_{\varphi,m}(y)\rightarrow\big[\varphi(m,y)\leftrightarrow\varphi(x,y)\big]\Big]$$

We write $p(x)\sim_Mq(x)$ if 

$\phi(p\,;\U)\neq\0\IFF\phi(q\,;\U)\neq\0$ 

for every $\phi(x,z)\in L(M)$ 

\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Uniform samples}\label{samples}
We call $\U$ the domain of the home sort.
%
This curries all the structure.
%
The domain of the second sort,

Fix a tuple of variables $x$ and let $\bar x=\<x_i:i<\omega\>$, where $|x_i|=|x|$.
%
For $p(\bar x)\in S(\U)$ and $\psi(x)\in L(\U)$ we define ($n>1$)

\ceq{\hfill\emph{$\Av_{p\restriction n}\,\psi(x)$} }
{=}
{\frac1n\Big|\big\{i<n\ :\ p(\bar x)\proves\psi(x_i)\big\}\Big|}

If $p(\bar x)$ is the type containing $\b ar x=\bar a$ for some $\bar a\in \U^{|x|\cdot\omega}$,
we write \emph{$\Av_{\bar a{\restriction n}}\,\psi(x)$.}

\begin{definition}
  We say that $p(\bar x)\in S(\U)$ is a \emph{sample\/}
  if the limit below exists for every formula $\psi(x)\in L(\U)$.

  \ceq{\hfill\emph{$\Av_p\,\psi(x)$}}{=}{\lim_{n\to\infty}\Av_{p\restriction n}\,\psi(x).}

  Let $\phi(x,z)\in L$ be given.
  %
  We say that $p(\bar x)$ is a \emph{$\phi$-sample\/}
  if the formula $\psi(x)$ above is restricted to range over those of the form $\phi(x,b)$
  for $b\in\U^{|z|}$.

  We say that $p(\bar x)$ is a \emph{uniform $\phi$-sample\/} if it is a sample and
  for every $\epsilon>0$ there is a $k$ such that $\Av_{p\restriction n}\,\phi(x,b)$
  is within $\epsilon$ from $\Av_p\,\phi(x,b)$ for all $n>k$ and $b\in\U^{|z|}$.

  We say that $p(\bar x)$ is a \emph{uniform sample\/} if it is a uniform
  $\phi$-sample for all $\phi(x,z)\in L$.\QED
\end{definition}

\begin{proposition}
  Let $p(\bar x)\in S(\U)$ be a sample finitely satisfied in $M$.
  %
  Let $q(x)\in S(M)$.
  %
  Then for every formula $\phi(x)\in L(\U)$ either

  \hfil$\displaystyle\inf\Big\{\Av_p\,\big(\psi(x)\wedge\phi(x)\big)\ :\ \psi(x)\in q\Big\}$

  is either $0$ or $\Av_p\,\phi(x)$.
\end{proposition}
\begin{proof}
  As $p(\bar x)$ is finitely satisfied in $M$ there is a tuple in $\bar a\in M^{|x|\cdot n}$
  such that $\Av_{\bar a}\,\big(\psi(x)\wedge\phi(x)\big)$ is within $\epsilon$ form the
  infimum above.
\end{proof}

Define

\ceq{\hfill\emph{$\Av_{p\restriction n}\,q(x)$}}
{=}
{\inf\Big\{\Av_{p\restriction n}\,\psi(x)\ :\ \psi(x)\in q\Big\}}

Clearly the infimum above is attained.

\begin{proposition}
  If $p(\bar x)$ is a sample and $q(x)\subseteq L(\U)$, then

  \ceq{\hfill\lim_{n\to\infty}\Av_{p\restriction n}\,q(x)}
  {=}
  {\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\}}
\end{proposition}

\begin{proof}
  Fix $\epsilon>0$.
  %
  Let $\phi(x)\in q$ be such that $\Av_p\,\phi(x)$ is within $\epsilon$ from the infimum above.
  %
  Let $k$ be such that $\Av_{p\restriction n}\,\phi(x)$ is within $\epsilon$ from  $\Av_p\,\phi(x)$ for every $n>k$.
  %
  Then, for every $n>k$,

  \ceq{\hfill\Av_{p\restriction n}\,q(x)}
  {\le}
  {\Av_{p\restriction n}\,\phi(x)}

  \ceq{}
  {\le}
  {\Av_p\,\phi(x) + \epsilon}

  \ceq{}
  {\le}
  {\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\} + 2\epsilon}

  For the converse inequality we inductively pick a sequence of integers $n_i$ and formulas $\psi_i(x)\in q$ as follows.
  %
  Let $n_0=1$ and $\psi_i(x)$ such that $\Av_{p\restriction {n_i}}\,\psi_i(x)=\Av_{p\restriction {n_i}}\,q(x)$.
  %
  Then $n_{i+1}$ be such that $\Av_p\,\psi_i(x)\le\Av_{p\restriction {n_{i+1}}}\,\psi_i(x)+\epsilon$.
  %
  Then

  \ceq{\hfill\inf\Big\{\Av_p\,\phi(x)\ :\ \phi(x)\in q\Big\}}
  {\le}
  {\inf\Big\{\Av_p\,\psi_i(x)\ :\ i<\omega\Big\}}

  \ceq{}
  {\le}
  {\inf\Big\{\Av_{p\restriction {n_{i+1}}}\,\psi_i(x)\ :\ i<\omega\Big\} + \epsilon}
  % {\Av_{p\restriction n}\,q(x) + \epsilon}
\end{proof}

\begin{corollary}
  Let $p(\bar x)$ be a sample finitely satisfied in $M$.
  %
  Let $q'(x)=q(x)\cup\{\phi(x)\}$ for $q(x)\in S(M)$ and $\phi(x)\in L(\U)$.
  %
  Then $\Av_p\,q'(x)$ is either $0$ or $1$.
\end{corollary}
\begin{proof}
  Under the assumptions of the corollary, for every $\epsilon>0$ there is an $n$ and a tuple $\bar a\in M^{|x|\cdot\omega}$ such that $\Av_{\bar a{\restriction n}}\,q'(x)$ is within $\epsilon$ from $\Av_p\,q'(x)$. As $\Av_{\bar a{\restriction n}}\,q'(x)$
\end{proof}



\begin{proposition}
  Let $\bar x=\<x_i:i<\omega\>$ and $|x_i|=|x|$ and let $p(\bar x)\in S(\U)$.
  %  
  Then the following are equivalent
  \begin{itemize}
    \item[1.] $p(\bar x)$ is a uniform external sample;
    \item[2.] for every $\epsilon>0$, there is an $n$ and a formula $\theta(\bar x)\in p$ such that $\Av_n\big(\bar a;\phi(x,b)\big)$ is within $\epsilon$ from $\Av_p\phi(x,b)$ for all $b\in\U^{|z|}$ and all $\bar a\models\theta(\bar x)$.
  \end{itemize}
\end{proposition}

\begin{proof}
  ???
\end{proof}

Vale anche/solo/nemmeno la versione non uniforme della proposizione?

Note that, if $p(\bar x)$ is definable, say over $M$, then there is a formula $\psi_{m/n}(z)\in L(M)$ such that

\ceq{\hfill\psi_{m/n}(z)}{\IFF}{\Av_n\big(p(\bar x);\phi(x,z)\big)=\frac{m}{n}.}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{References}
\begin{biblist}[]\normalsize

  \bib{DK}{book}{
    author={Dodos, Pandelis},
    author={Kanellopoulos, Vassilis},
    title={\href{http://users.uoa.gr/~pdodos/Publications/RT.pdf}
        {Ramsey theory for product spaces}},
    series={Mathematical Surveys and Monographs},
    volume={212},
    publisher={American Mathematical Society},
    %   publisher={American Mathematical Society, Providence, RI},
    date={2016},
  }
  \bib{DZ}{book}{
    author={Zambella, Domenico},
    title={\href{https://github.com/domenicozambella/creche/raw/master/creche.pdf}
        {A cr\`eche course in model theory}},
    date={2018},
    series={AMS Open Math Notes},
    note={(The link points to the github version)}
  }
\end{biblist}

\end{document}
